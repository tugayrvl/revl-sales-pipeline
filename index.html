<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RemVision Sales v3</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e17; overflow: auto; }
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: #111827; }
::-webkit-scrollbar-thumb { background: #2a3a50; border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #3b82f6; }
input:focus, select:focus, textarea:focus { border-color: #3b82f6 !important; }
a { color: #3b82f6; }
/* Responsive */
@media (max-width: 768px) {
  .stat-card { min-width: 80px !important; }
}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback, useMemo, useRef } = React;


// XLSX parsing
const parseXLSXFile = (arrayBuffer) => {
  const data = new Uint8Array(arrayBuffer);
  const workbook = window.XLSX.read(data, { type: 'array' });
  const sheetName = workbook.SheetNames[0];
  const sheet = workbook.Sheets[sheetName];
  const json = window.XLSX.utils.sheet_to_json(sheet, { defval: '' });
  const headers = json.length > 0 ? Object.keys(json[0]) : [];
  return { headers, rows: json };
};

// ============================================================
// UTILITY FUNCTIONS
// ============================================================

const turkishLower = (s) => {
  if (!s) return "";
  return s.replace(/Ä°/g, "i").replace(/I/g, "Ä±").replace(/Å/g, "ÅŸ").replace(/Ä/g, "ÄŸ").replace(/Ãœ/g, "Ã¼").replace(/Ã–/g, "Ã¶").replace(/Ã‡/g, "Ã§").toLowerCase();
};

const turkishUpper = (s) => {
  if (!s) return "";
  return s.replace(/i/g, "Ä°").replace(/Ä±/g, "I").replace(/ÅŸ/g, "Å").replace(/ÄŸ/g, "Ä").replace(/Ã¼/g, "Ãœ").replace(/Ã¶/g, "Ã–").replace(/Ã§/g, "Ã‡").toUpperCase();
};

const levenshtein = (a, b) => {
  const al = turkishLower(a), bl = turkishLower(b);
  const m = al.length, n = bl.length;
  const dp = Array.from({ length: m + 1 }, () => Array(n + 1).fill(0));
  for (let i = 0; i <= m; i++) dp[i][0] = i;
  for (let j = 0; j <= n; j++) dp[0][j] = j;
  for (let i = 1; i <= m; i++)
    for (let j = 1; j <= n; j++)
      dp[i][j] = al[i-1] === bl[j-1] ? dp[i-1][j-1] : 1 + Math.min(dp[i-1][j], dp[i][j-1], dp[i-1][j-1]);
  return dp[m][n];
};

const similarity = (a, b) => {
  if (!a || !b) return 0;
  const al = turkishLower(a.trim()), bl = turkishLower(b.trim());
  if (al === bl) return 1;
  if (al.includes(bl) || bl.includes(al)) return 0.85;
  const maxLen = Math.max(al.length, bl.length);
  return maxLen === 0 ? 1 : 1 - levenshtein(al, bl) / maxLen;
};

const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
const getWeekNumber = (d = new Date()) => {
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay() || 7));
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
  return Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
};
const currentWeek = getWeekNumber();
const currentYear = new Date().getFullYear();

const getWeekDates = (week, year = currentYear) => {
  const jan1 = new Date(year, 0, 1);
  const days = (week - 1) * 7;
  const dayOfWeek = jan1.getDay() || 7; // Monday = 1
  const monday = new Date(year, 0, 1 + days - dayOfWeek + 1);
  const sunday = new Date(monday);
  sunday.setDate(monday.getDate() + 6);
  const fmt = (d) => `${d.getDate()} ${["Oca","Åub","Mar","Nis","May","Haz","Tem","AÄŸu","Eyl","Eki","Kas","Ara"][d.getMonth()]}`;
  return { monday, sunday, label: `${fmt(monday)} â€“ ${fmt(sunday)}` };
};

// ============================================================
// DATA STORE (localStorage-backed, Supabase-ready)
// ============================================================

const STORAGE_KEY = "sales_pipeline_data";

const defaultData = () => ({
  companies: [],
  contacts: [],
  callLogs: [],
  contactProfiles: [],
  todos: [],
  competitors: [],
  coldMailTemplates: [],
  coldMailSends: [],
  linkedinOutreach: [],
  avmVisits: [],
  excelImports: [],
  fuzzyBlacklist: [],
  demoProcesses: [],
});

const loadData = () => {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? { ...defaultData(), ...JSON.parse(raw) } : defaultData();
  } catch { return defaultData(); }
};

const saveData = (data) => {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
};

// ============================================================
// ICONS (inline SVG components)
// ============================================================

const Icon = ({ d, size = 16, color = "currentColor", ...props }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d={d}/></svg>
);

const PhoneIcon = (p) => <Icon d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6A19.79 19.79 0 012.12 4.18 2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z" {...p}/>;
const MailIcon = (p) => <Icon d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2zM22 6l-10 7L2 6" {...p}/>;
const LinkedinIcon = (p) => <Icon d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-4 0v7h-4v-7a6 6 0 016-6zM2 9h4v12H2zM4 6a2 2 0 100-4 2 2 0 000 4z" {...p}/>;
const PlusIcon = (p) => <Icon d="M12 5v14M5 12h14" {...p}/>;
const SearchIcon = (p) => <Icon d="M11 17.25a6.25 6.25 0 110-12.5 6.25 6.25 0 010 12.5zM16 16l4.5 4.5" {...p}/>;
const EditIcon = (p) => <Icon d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z" {...p}/>;
const TrashIcon = (p) => <Icon d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" {...p}/>;
const ChevronDown = (p) => <Icon d="M6 9l6 6 6-6" {...p}/>;
const ChevronRight = (p) => <Icon d="M9 18l6-6-6-6" {...p}/>;
const UploadIcon = (p) => <Icon d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12" {...p}/>;
const CheckIcon = (p) => <Icon d="M20 6L9 17l-5-5" {...p}/>;
const XIcon = (p) => <Icon d="M18 6L6 18M6 6l12 12" {...p}/>;
const GlobeIcon = (p) => <Icon d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10zM2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10A15.3 15.3 0 0112 2z" {...p}/>;
const SyncIcon = (p) => <Icon d="M23 4v6h-6M1 20v-6h6M20.49 9A9 9 0 005.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 013.51 15" {...p}/>;
const BuildingIcon = (p) => <Icon d="M3 21h18M3 10h18M3 7l9-4 9 4M4 10v11M20 10v11M8 14v.01M12 14v.01M16 14v.01M8 18v.01M12 18v.01M16 18v.01" {...p}/>;

// ============================================================
// STYLES
// ============================================================

const colors = {
  bg: "#0a0e17",
  surface: "#111827",
  surfaceHover: "#1a2332",
  card: "#151d2b",
  border: "#1e293b",
  borderLight: "#2a3a50",
  text: "#e2e8f0",
  textMuted: "#8896ab",
  textDim: "#5a6a80",
  accent: "#3b82f6",
  accentDim: "#1e3a6e",
  green: "#22c55e",
  greenDim: "#0a3d1e",
  yellow: "#eab308",
  yellowDim: "#3d2e08",
  red: "#ef4444",
  redDim: "#3d0a0a",
  orange: "#f97316",
  orangeDim: "#3d1e08",
  purple: "#a855f7",
};

const s = {
  app: { fontFamily: "'JetBrains Mono', 'SF Mono', 'Fira Code', monospace", background: colors.bg, color: colors.text, minHeight: "100vh", fontSize: 13 },
  header: { display: "flex", alignItems: "center", justifyContent: "space-between", padding: "12px 20px", background: colors.surface, borderBottom: `1px solid ${colors.border}`, position: "sticky", top: 0, zIndex: 100 },
  logo: { fontSize: 16, fontWeight: 800, letterSpacing: "0.05em", color: colors.accent },
  tabs: { display: "flex", gap: 2 },
  tab: (active) => ({ padding: "6px 14px", cursor: "pointer", borderRadius: 6, background: active ? colors.accentDim : "transparent", color: active ? colors.accent : colors.textMuted, fontWeight: active ? 700 : 500, fontSize: 12, border: "none", transition: "all 0.15s" }),
  main: { display: "flex", gap: 0, height: "calc(100vh - 49px)" },
  sidebar: { width: 220, background: colors.surface, borderRight: `1px solid ${colors.border}`, padding: "12px 0", overflowY: "auto", flexShrink: 0 },
  sideItem: (active) => ({ padding: "8px 16px", cursor: "pointer", background: active ? colors.accentDim : "transparent", color: active ? colors.accent : colors.textMuted, fontSize: 12, fontWeight: active ? 600 : 400, borderLeft: active ? `3px solid ${colors.accent}` : "3px solid transparent", display: "flex", alignItems: "center", gap: 8 }),
  content: { flex: 1, overflowY: "auto", padding: 20 },
  card: { background: colors.card, border: `1px solid ${colors.border}`, borderRadius: 8, padding: 16, marginBottom: 12 },
  statCard: (color) => ({ background: colors.card, border: `1px solid ${colors.border}`, borderRadius: 8, padding: "14px 18px", minWidth: 140, borderLeft: `3px solid ${color}` }),
  badge: (color, bg) => ({ display: "inline-flex", alignItems: "center", padding: "2px 8px", borderRadius: 10, fontSize: 11, fontWeight: 600, color, background: bg, whiteSpace: "nowrap" }),
  btn: (variant = "default") => ({
    padding: "6px 14px", borderRadius: 6, border: "none", cursor: "pointer", fontSize: 12, fontWeight: 600, fontFamily: "inherit",
    ...(variant === "primary" ? { background: colors.accent, color: "#fff" } :
      variant === "danger" ? { background: colors.redDim, color: colors.red } :
      variant === "success" ? { background: colors.greenDim, color: colors.green } :
      { background: colors.surfaceHover, color: colors.textMuted, border: `1px solid ${colors.border}` })
  }),
  input: { background: colors.surface, border: `1px solid ${colors.border}`, borderRadius: 6, padding: "6px 10px", color: colors.text, fontSize: 12, fontFamily: "inherit", outline: "none", width: "100%" },
  select: { background: colors.surface, border: `1px solid ${colors.border}`, borderRadius: 6, padding: "6px 10px", color: colors.text, fontSize: 12, fontFamily: "inherit", outline: "none" },
  table: { width: "100%", borderCollapse: "collapse", fontSize: 12 },
  th: { textAlign: "left", padding: "8px 10px", borderBottom: `1px solid ${colors.border}`, color: colors.textMuted, fontWeight: 600, fontSize: 11, textTransform: "uppercase", letterSpacing: "0.05em" },
  td: { padding: "8px 10px", borderBottom: `1px solid ${colors.border}`, verticalAlign: "top" },
  modal: { position: "fixed", inset: 0, background: "rgba(0,0,0,0.7)", display: "flex", alignItems: "center", justifyContent: "center", zIndex: 200, backdropFilter: "blur(4px)" },
  modalContent: { background: colors.surface, border: `1px solid ${colors.border}`, borderRadius: 12, padding: 24, maxWidth: 600, width: "90%", maxHeight: "80vh", overflowY: "auto" },
  sidePanel: { position: "fixed", top: 0, right: 0, bottom: 0, width: 420, maxWidth: "90vw", background: colors.surface, borderLeft: `1px solid ${colors.border}`, boxShadow: "-4px 0 20px rgba(0,0,0,0.3)", zIndex: 200, display: "flex", flexDirection: "column" },
  sidePanelLeft: { position: "fixed", top: 0, left: 0, bottom: 0, width: 700, maxWidth: "60vw", background: colors.surface, borderRight: `1px solid ${colors.border}`, boxShadow: "4px 0 20px rgba(0,0,0,0.3)", zIndex: 201, display: "flex", flexDirection: "column" },
  sidePanelContent: { flex: 1, padding: 20, overflowY: "auto" },
  sidePanelBackdrop: { position: "fixed", inset: 0, background: "rgba(0,0,0,0.3)", zIndex: 199 },
  syncBar: (visible) => ({ position: "fixed", bottom: 16, right: 16, background: colors.greenDim, border: `1px solid ${colors.green}`, borderRadius: 8, padding: "8px 14px", display: "flex", alignItems: "center", gap: 8, fontSize: 11, color: colors.green, opacity: visible ? 1 : 0, transition: "opacity 0.3s", pointerEvents: visible ? "auto" : "none", zIndex: 300 }),
};

// ============================================================
// COMPONENTS
// ============================================================

const StatCard = ({ label, value, color = colors.accent, sub }) => (
  <div style={s.statCard(color)}>
    <div style={{ fontSize: 22, fontWeight: 800, color }}>{value}</div>
    <div style={{ fontSize: 11, color: colors.textMuted, marginTop: 2 }}>{label}</div>
    {sub && <div style={{ fontSize: 10, color: colors.textDim, marginTop: 2 }}>{sub}</div>}
  </div>
);

const Badge = ({ children, color = colors.accent, bg = colors.accentDim }) => (
  <span style={s.badge(color, bg)}>{children}</span>
);

const ContactStatusBadge = ({ contact }) => {
  const hasPhone = !!contact.phone;
  const hasEmail = !!contact.email;
  const hasLinkedin = !!contact.linkedin;
  return (
    <div style={{ display: "flex", gap: 4 }}>
      {hasPhone && <Badge color={colors.green} bg={colors.greenDim}>ğŸ“</Badge>}
      {hasEmail && <Badge color={colors.yellow} bg={colors.yellowDim}>âœ‰ï¸</Badge>}
      {hasLinkedin && <Badge color={colors.accent} bg={colors.accentDim}>in</Badge>}
      {!hasPhone && !hasEmail && !hasLinkedin && <Badge color={colors.red} bg={colors.redDim}>Eksik</Badge>}
    </div>
  );
};

const PipelineBadge = ({ stage }) => {
  const map = {
    contact_ready: { label: "Kontakt HazÄ±r", color: colors.green, bg: colors.greenDim },
    no_ready_contact: { label: "HazÄ±r Kontakt Yok", color: colors.orange, bg: colors.orangeDim },
    unreached: { label: "UlaÅŸÄ±lamadÄ±", color: colors.red, bg: colors.redDim },
    wrong_person: { label: "YanlÄ±ÅŸ KiÅŸi", color: colors.yellow, bg: colors.yellowDim },
    meeting: { label: "ToplantÄ± AlÄ±ndÄ±", color: colors.purple, bg: "#2d1a4e" },
    not_interested: { label: "Ä°lgilenmiyor", color: colors.textDim, bg: colors.surfaceHover },
  };
  const m = map[stage] || { label: stage || "â€”", color: colors.textMuted, bg: colors.surfaceHover };
  return <Badge color={m.color} bg={m.bg}>{m.label}</Badge>;
};

const StatusBadge = ({ status, hasPhoneContact }) => {
  // Auto-determine if no manual status set
  const effectiveStatus = status || (hasPhoneContact ? "contact_ready" : "no_ready_contact");
  const map = {
    contact_ready: { label: "Kontakt HazÄ±r", color: colors.green, bg: colors.greenDim },
    no_ready_contact: { label: "âš ï¸ HazÄ±r Kontakt Yok", color: colors.orange, bg: colors.orangeDim },
    unreached: { label: "UlaÅŸÄ±lamadÄ±", color: colors.red, bg: colors.redDim },
    wrong_person: { label: "YanlÄ±ÅŸ KiÅŸi", color: colors.yellow, bg: colors.yellowDim },
    meeting: { label: "ToplantÄ± AlÄ±ndÄ±", color: colors.purple, bg: "#2d1a4e" },
    not_interested: { label: "Ä°lgilenmiyor", color: colors.textDim, bg: colors.surfaceHover },
  };
  const m = map[effectiveStatus] || { label: "â€”", color: colors.textMuted, bg: colors.surfaceHover };
  return <Badge color={m.color} bg={m.bg}>{m.label}</Badge>;
};

const DeviceBadge = ({ status, brand }) => {
  const truncate = (text, max = 12) => text && text.length > max ? text.slice(0, max) + "â€¦" : text;
  if (!status || status === "unknown") return <Badge color={colors.textDim} bg={colors.surfaceHover} title="Bilinmiyor">â“ Bilinmiyor</Badge>;
  if (status === "none") return <Badge color={colors.green} bg={colors.greenDim} title="Cihaz Yok">âœ… Cihaz Yok</Badge>;
  if (status === "ours") return <Badge color={colors.accent} bg={colors.accentDim} title="Bizde">ğŸ  Bizde</Badge>;
  // Competitor - show brand name if known, otherwise "Cihaz Var"
  if (brand) return <Badge color={colors.red} bg={colors.redDim} title={brand}>ğŸ”´ {truncate(brand)}</Badge>;
  return <Badge color={colors.orange} bg={colors.orangeDim} title="Cihaz Var">âš ï¸ Cihaz Var</Badge>;
};

// ============================================================
// EXCEL PARSER (TSV/CSV with preview)
// ============================================================

const parseExcel = (text, separator = "\t") => {
  // Use Papa Parse for proper multiline CSV handling
  const result = Papa.parse(text, {
    header: true,
    skipEmptyLines: true,
    delimiter: separator === "\t" ? "\t" : ","
  });
  const headers = result.meta.fields || [];
  const rows = result.data || [];
  return { headers, rows };
};

// ============================================================
// MAIN APP
// ============================================================

function SalesPipelineApp() {
  const [data, setData] = useState(loadData);
  const [activeTab, setActiveTab] = useState("weekly");
  const [selectedWeek, setSelectedWeek] = useState(currentWeek);
  const [expandedFirm, setExpandedFirm] = useState(null);
  const [showModal, setShowModal] = useState(null);
  const [modalData, setModalData] = useState({});
  const [searchTerm, setSearchTerm] = useState("");
  const [syncNotif, setSyncNotif] = useState(false);
  const [importPreview, setImportPreview] = useState(null);
  const [fuzzyMatches, setFuzzyMatches] = useState([]);
  const [callResult, setCallResult] = useState(null);
  const fileInputRef = useRef(null);
  const fileInputAvmRef = useRef(null);
  const [importType, setImportType] = useState("lusha");
  const [weekFilter, setWeekFilter] = useState("all"); // "all" | "ready" | "no_contact" | "followup"
  const [companyFilter, setCompanyFilter] = useState({ device: "all", phone: "all", assigned: "all" }); // device: all|none|competitor, phone: all|has_phone|no_phone, assigned: all|unassigned|assigned
  const [targetWeekPicker, setTargetWeekPicker] = useState(null); // { companyId, show }
  const [assignWeek, setAssignWeek] = useState(currentWeek);
  const [selectedContact, setSelectedContact] = useState(null); // For contact profile modal
  const [showCallPanel, setShowCallPanel] = useState(false); // Separate state for call panel (can coexist with modals)

  // Auto-save
  useEffect(() => { saveData(data); }, [data]);

  // Migrate old pipeline data to new trackingType/status
  useEffect(() => {
    let needsMigration = false;
    const migratedCompanies = data.companies.map(c => {
      if (c.pipeline && !c.trackingType) {
        needsMigration = true;
        const migrated = { ...c };
        // Migrate pipeline to trackingType
        if (c.pipeline === "regular_followup") {
          migrated.trackingType = "followup";
        } else if (c.targetWeek) {
          migrated.trackingType = "target";
        }
        // Migrate pipeline to status
        if (c.pipeline === "contact_ready") migrated.status = "contact_ready";
        else if (c.pipeline === "unreached") migrated.status = "unreached";
        else if (c.pipeline === "meeting_scheduled") migrated.status = "meeting";
        else if (c.pipeline === "not_interested") migrated.status = "not_interested";
        return migrated;
      }
      return c;
    });
    if (needsMigration) {
      setData(prev => ({ ...prev, companies: migratedCompanies }));
    }
  }, []);

  const showSync = useCallback((msg) => {
    setSyncNotif(msg || "Kaydedildi âœ“");
    setTimeout(() => setSyncNotif(false), 2000);
  }, []);

  const updateData = useCallback((fn) => {
    setData(prev => {
      const next = fn(prev);
      return { ...next };
    });
    showSync("Senkronize edildi âœ“");
  }, [showSync]);

  // ---- DERIVED DATA ----
  const weekCompanies = useMemo(() =>
    data.companies.filter(c => c.trackingType === "target" && c.targetWeek === selectedWeek && c.targetYear === currentYear),
    [data.companies, selectedWeek]
  );

  const followupCompanies = useMemo(() =>
    data.companies.filter(c => c.trackingType === "followup" && c.followupWeek === selectedWeek && c.followupYear === currentYear),
    [data.companies, selectedWeek]
  );

  // Also include followups that don't have a specific week assigned but are active
  const allFollowups = useMemo(() =>
    data.companies.filter(c => c.trackingType === "followup"),
    [data.companies]
  );

  const getContacts = useCallback((companyId) =>
    data.contacts.filter(c => c.companyId === companyId).sort((a, b) => (a.priority || 99) - (b.priority || 99)),
    [data.contacts]
  );

  const getParentCompany = useCallback((companyId) => {
    const company = data.companies.find(c => c.id === companyId);
    if (company?.parentId) return data.companies.find(c => c.id === company.parentId);
    return null;
  }, [data.companies]);

  const getChildCompanies = useCallback((companyId) =>
    data.companies.filter(c => c.parentId === companyId),
    [data.companies]
  );

  const getCallLogs = useCallback((companyId) =>
    data.callLogs.filter(c => c.companyId === companyId).sort((a, b) => new Date(b.date) - new Date(a.date)),
    [data.callLogs]
  );

  const getProfile = useCallback((contactId) =>
    data.contactProfiles.find(p => p.contactId === contactId),
    [data.contactProfiles]
  );

  // Stats
  const stats = useMemo(() => {
    const cs = data.companies;
    const cts = data.contacts;
    const wk = weekCompanies;
    const wkIds = new Set(wk.map(c => c.id));
    const wkContacts = cts.filter(c => wkIds.has(c.companyId));
    return {
      totalCompanies: cs.length,
      noDevice: cs.filter(c => c.deviceStatus === "none").length,
      hasDevice: cs.filter(c => c.deviceStatus === "competitor").length,
      unknownDevice: cs.filter(c => !c.deviceStatus || c.deviceStatus === "unknown").length,
      totalContacts: cts.length,
      withPhone: cts.filter(c => c.phone).length,
      withEmail: cts.filter(c => c.email).length,
      onlyLinkedin: cts.filter(c => c.linkedin && !c.phone && !c.email).length,
      parentCompanies: cs.filter(c => c.isParent).length,
      weekTargets: wk.length,
      weekReady: wk.filter(f => wkContacts.some(c => c.companyId === f.id && c.phone)).length,
      weekNoContact: wk.filter(f => !wkContacts.some(c => c.companyId === f.id)).length,
      weekCalls: data.callLogs.filter(l => l.week === selectedWeek && l.year === currentYear).length,
      weekMeetings: data.callLogs.filter(l => l.week === selectedWeek && l.year === currentYear && l.result === "meeting").length,
      weekFollowups: allFollowups.length,
    };
  }, [data, weekCompanies, selectedWeek]);

  // ---- FIRM SORTING (for weekly view) ----
  const sortedWeekCompanies = useMemo(() => {
    return [...weekCompanies].sort((a, b) => {
      const aContacts = getContacts(a.id);
      const bContacts = getContacts(b.id);
      const aHasPhone = aContacts.some(c => c.phone);
      const bHasPhone = bContacts.some(c => c.phone);
      const aHasAny = aContacts.length > 0;
      const bHasAny = bContacts.length > 0;
      if (aHasPhone && !bHasPhone) return -1;
      if (!aHasPhone && bHasPhone) return 1;
      if (aHasAny && !bHasAny) return -1;
      if (!aHasAny && bHasAny) return 1;
      return turkishLower(a.name).localeCompare(turkishLower(b.name), "tr");
    });
  }, [weekCompanies, getContacts]);

  // ---- IMPORT HANDLERS ----
  const handleFileUpload = (e) => {
    const files = Array.from(e.target.files);
    if (!files.length) return;

    const allRows = [];
    let headers = [];
    let processed = 0;

    const checkDone = () => {
      processed++;
      if (processed === files.length) {
        setImportPreview({ headers, rows: allRows, fileCount: files.length });
      }
    };

    files.forEach(file => {
      const isXlsx = file.name.endsWith(".xlsx") || file.name.endsWith(".xls");

      if (isXlsx) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const result = parseXLSXFile(ev.target.result);
            if (result.headers.length > headers.length) headers = result.headers;
            allRows.push(...result.rows);
          } catch (err) {
            console.error("XLSX parse error:", err);
            alert("XLSX okuma hatasÄ±: " + err.message);
          }
          checkDone();
        };
        reader.readAsArrayBuffer(file);
      } else {
        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const text = ev.target.result;
            const sep = text.includes("\t") ? "\t" : ",";
            const parsed = parseExcel(text, sep);
            if (parsed.headers.length > headers.length) headers = parsed.headers;
            allRows.push(...parsed.rows);
          } catch (err) {
            console.error("CSV parse error:", err);
            alert("CSV okuma hatasÄ±: " + err.message);
          }
          checkDone();
        };
        reader.readAsText(file, "UTF-8");
      }
    });

    e.target.value = "";
  };

  const processLushaImport = (parsed) => {
    const { rows } = parsed;
    let newContacts = 0, updatedContacts = 0, newCompanies = 0, firmOnlyRows = 0;

    const findCol = (row, ...names) => {
      for (const name of names) {
        // Handle BOM prefix
        const bomName = "\ufeff" + name;
        if (row[bomName] !== undefined && row[bomName] !== null && row[bomName] !== "") return String(row[bomName]);
        if (row[name] !== undefined && row[name] !== null && row[name] !== "") return String(row[name]);
        // Only exact match (case insensitive) - no includes to avoid "Company Country" matching "Company"
        const key = Object.keys(row).find(k => {
          const clean = k.replace(/^\ufeff/, "").trim();
          return turkishLower(clean) === turkishLower(name);
        });
        if (key && row[key] !== undefined && row[key] !== null && row[key] !== "") return String(row[key]);
      }
      return "";
    };

    updateData(prev => {
      const next = { ...prev, contacts: [...prev.contacts], companies: [...prev.companies] };

      rows.forEach((row, idx) => {
        // Build full name
        const fullName = findCol(row, "Full Name", "Name", "Ä°sim", "Ad Soyad");
        const firstName = findCol(row, "First Name", "Ad");
        const lastName = findCol(row, "Last Name", "Soyad");
        const name = fullName || `${firstName} ${lastName}`.trim();

        // Company - ONLY from "Company Name" column, nothing else
        const companyRaw = row["Company Name"] !== undefined ? row["Company Name"] : (row["\ufeffCompany Name"] || "");
        const company = (typeof companyRaw === "string" ? companyRaw : String(companyRaw || "")).trim();

        // If neither name nor company, truly empty row â€” skip
        if (!name && !company) return;

        // Contact details
        const title = findCol(row, "Job Title", "Title", "Ãœnvan", "Pozisyon");
        const seniority = findCol(row, "Seniority");

        // Phones â€” both Phone 1 and Phone 2, ignore Type columns
        const phone1 = findCol(row, "Phone 1");
        const phone2 = findCol(row, "Phone 2");
        const phoneGeneric = findCol(row, "Phone", "Telefon", "Direct Phone", "Mobile Phone", "Cep", "Tel");
        const phone = phone1 || phoneGeneric;

        // Email â€” Work Email priority, then others
        const workEmail = findCol(row, "Work Email");
        const directEmail = findCol(row, "Direct Email");
        const additionalEmail = findCol(row, "Additional Email 1");
        const genericEmail = findCol(row, "Email", "E-posta", "Mail");
        const email = workEmail || directEmail || genericEmail || additionalEmail;

        // LinkedIn â€” person's LinkedIn URL
        const linkedin = findCol(row, "LinkedIn URL");

        // Company details from Lusha
        const companyWebsite = findCol(row, "Company Website");
        const companyLinkedin = findCol(row, "Company linkedin URL", "Company LinkedIn URL");
        const companyDomain = findCol(row, "Company Domain");

        // Check if this is a "new firm only" row (from combined excel)
        const isNewFirmaOnly = row["_yeniFirma"] === true || row["_yeniFirma"] === "true" || row["_yeniFirma"] === "TRUE";

        // Find or create company
        let comp = company ? next.companies.find(c => similarity(c.name, company) > 0.8) : null;
        if (!comp && company) {
          comp = {
            id: uid(), name: company,
            deviceStatus: "unknown", deviceBrand: "",
            pipeline: "new_target",
            targetWeek: null, targetYear: null,
            parentId: null, isParent: false,
            linkedin: companyLinkedin || "",
            website: companyWebsite || companyDomain || "",
            notes: "",
            createdAt: new Date().toISOString()
          };
          next.companies.push(comp);
          newCompanies++;
        } else if (comp) {
          // Update company with Lusha data if missing
          if (companyLinkedin && !comp.linkedin) comp.linkedin = companyLinkedin;
          if ((companyWebsite || companyDomain) && !comp.website) comp.website = companyWebsite || companyDomain;
        }

        if (!comp) return;

        // If no name, this is a company-only row â€” firm created above, done
        if (!name) { firmOnlyRows++; return; }

        // Find existing contact by name + company
        const existing = next.contacts.find(c =>
          c.companyId === comp.id && similarity(c.name, name) > 0.85
        );

        if (existing) {
          let updated = false;
          if (phone && !existing.phone) { existing.phone = phone; updated = true; }
          if (phone2 && !existing.phone2) { existing.phone2 = phone2; updated = true; }
          if (email && !existing.email) { existing.email = email; updated = true; }
          if (linkedin && !existing.linkedin) { existing.linkedin = linkedin; updated = true; }
          if (title && !existing.title) { existing.title = title; updated = true; }
          if (seniority && !existing.seniority) { existing.seniority = seniority; updated = true; }
          if (updated) updatedContacts++;
        } else {
          next.contacts.push({
            id: uid(), name, title, seniority: seniority || "",
            phone, phone2: phone2 || "", email, linkedin,
            companyId: comp.id, source: "lusha", status: "active",
            priority: next.contacts.filter(c => c.companyId === comp.id).length + 1,
            createdAt: new Date().toISOString()
          });
          newContacts++;
        }

        // Update company pipeline if contact has phone
        if (phone && (comp.pipeline === "new_target" || comp.pipeline === "searching_contact")) {
          comp.pipeline = "contact_ready";
        } else if ((email || linkedin) && comp.pipeline === "new_target") {
          comp.pipeline = "searching_contact";
        }
      });

      return next;
    });

    setImportPreview(null);
    alert(`Lusha import tamamlandÄ±!\n${newCompanies} yeni firma\n${newContacts} yeni kontakt\n${updatedContacts} gÃ¼ncellenen kontakt${firmOnlyRows > 0 ? `\n${firmOnlyRows} sadece firma (kontaktsÄ±z)` : ""}\nToplam ${rows.length} satÄ±r iÅŸlendi`);
  };

  const processAVMImport = (parsed) => {
    const { rows, headers } = parsed;
    let newCompanies = 0, updatedCompanies = 0;

    const findCol = (row, ...names) => {
      for (const name of names) {
        if (row[name] !== undefined && row[name] !== null && row[name] !== "") return String(row[name]);
        // Exact match only (case insensitive)
        const key = Object.keys(row).find(k => turkishLower(k.trim()) === turkishLower(name));
        if (key && row[key] !== undefined && row[key] !== null && row[key] !== "") return String(row[key]);
      }
      return "";
    };

    // Determine if "boÅŸ" means no device
    const isNoDevice = (val) => {
      if (!val) return false; // empty cell = unknown
      const v = turkishLower(val.trim());
      return v === "boÅŸ" || v.startsWith("boÅŸ ") || v.startsWith("boÅŸ-") || v.startsWith("boÅŸ,") ||
             v === "yok" || v === "gÃ¶rÃ¼lmedi" || v.startsWith("gÃ¶rÃ¼lmedi") ||
             v === "yeni sÃ¶kÃ¼lmÃ¼ÅŸ boÅŸ" || v.includes("boÅŸ gibi");
    };

    const isOurDevice = (val) => {
      if (!val) return false;
      const v = turkishLower(val.trim());
      return v === "biz" || v === "bizde" || v.startsWith("biz ") || v.startsWith("bizde ");
    };

    updateData(prev => {
      const next = { ...prev, companies: [...prev.companies] };
      let lastAvm = "";

      rows.forEach(row => {
        // AVM fill-down: if AVM cell is empty, use the last known AVM
        const avmVal = findCol(row, "AVM");
        if (avmVal) lastAvm = avmVal.trim();

        const name = findCol(row, "Firma", "Firma AdÄ±", "MaÄŸaza", "Brand", "Marka");
        const device = findCol(row, "Cihaz", "Cihaz Durumu");
        const photo = findCol(row, "REFERANS FOTO", "FotoÄŸraf", "Foto");
        const tarih = findCol(row, "Tarih");

        if (!name || name.trim().length < 2) return;

        const nameTrimmed = name.trim();
        const deviceTrimmed = device.trim();
        const deviceLower = turkishLower(deviceTrimmed);

        let deviceStatus, deviceBrand;
        if (!deviceTrimmed) {
          // Empty cell â€” we don't know
          deviceStatus = "unknown";
          deviceBrand = "";
        } else if (isNoDevice(deviceTrimmed)) {
          deviceStatus = "none";
          deviceBrand = "";
        } else if (isOurDevice(deviceTrimmed)) {
          deviceStatus = "ours";
          deviceBrand = "RemVision";
        } else {
          deviceStatus = "competitor";
          deviceBrand = deviceTrimmed;
        }

        let comp = next.companies.find(c => similarity(c.name, nameTrimmed) > 0.75);
        if (!comp) {
          comp = {
            id: uid(), name: nameTrimmed,
            deviceStatus, deviceBrand,
            pipeline: "new_target",
            targetWeek: null, targetYear: null,
            parentId: null, isParent: false,
            linkedin: "", website: "",
            avm: lastAvm,
            photo: photo || "",
            visitDate: tarih || "",
            notes: "",
            createdAt: new Date().toISOString()
          };
          next.companies.push(comp);
          newCompanies++;
        } else {
          // Update existing company with AVM data
          if (deviceStatus !== "unknown") {
            comp.deviceStatus = deviceStatus;
            comp.deviceBrand = deviceBrand;
          }
          if (lastAvm && !comp.avm) comp.avm = lastAvm;
          if (photo && !comp.photo) comp.photo = photo;
          if (tarih && !comp.visitDate) comp.visitDate = tarih;
          updatedCompanies++;
        }
      });

      return next;
    });

    setImportPreview(null);
    alert(`AVM import tamamlandÄ±!\n${newCompanies} yeni firma\n${updatedCompanies} gÃ¼ncellenen firma\nToplam ${rows.length} satÄ±r iÅŸlendi`);
  };

  // ---- MODAL HANDLERS ----
  const openAddCompany = () => {
    setModalData({ name: "", deviceStatus: "unknown", deviceBrand: "", pipeline: "new_target", targetWeek: selectedWeek, linkedin: "", website: "", notes: "", isParent: false, parentId: "" });
    setShowModal("addCompany");
  };

  const saveCompany = () => {
    updateData(prev => ({
      ...prev,
      companies: [...prev.companies, { ...modalData, id: uid(), targetYear: currentYear, createdAt: new Date().toISOString() }]
    }));
    setShowModal(null);
  };

  const openAddContact = (companyId) => {
    setModalData({ name: "", title: "", phone: "", email: "", linkedin: "", companyId, source: "manual" });
    setShowModal("addContact");
  };

  const saveContact = () => {
    updateData(prev => {
      const newContact = { ...modalData, id: uid(), status: "active", priority: prev.contacts.filter(c => c.companyId === modalData.companyId).length + 1, createdAt: new Date().toISOString() };
      let updatedCompanies = prev.companies;

      // Auto-update pipeline to "contact_ready" if phone provided
      if (modalData.phone) {
        const company = prev.companies.find(c => c.id === modalData.companyId);
        if (company && (!company.status || company.status === "no_ready_contact")) {
          updatedCompanies = prev.companies.map(c =>
            c.id === modalData.companyId ? { ...c, status: "contact_ready" } : c
          );
        }
      }

      return { ...prev, contacts: [...prev.contacts, newContact], companies: updatedCompanies };
    });
    setShowModal(null);
  };

  const deleteContact = (contactId) => {
    updateData(prev => ({
      ...prev,
      contacts: prev.contacts.filter(c => c.id !== contactId)
    }));
    showSync("Kontakt silindi âœ“");
  };

  const openCallLog = (company, contact) => {
    setCallResult({ companyId: company.id, contactId: contact.id, contactName: contact.name, companyName: company.name, phone: contact.phone, result: "", notes: "", meetingDate: "", date: new Date().toISOString(), week: selectedWeek, year: currentYear });
    setShowCallPanel(true);
  };

  const saveCallLog = () => {
    updateData(prev => {
      const next = { ...prev, callLogs: [...prev.callLogs, { ...callResult, id: uid() }] };
      // Update status
      const comp = next.companies.find(c => c.id === callResult.companyId);
      if (comp) {
        if (callResult.result === "meeting") comp.status = "meeting";
        else if (callResult.result === "introduced") { comp.status = "contact_ready"; comp.trackingType = "followup"; }
        else if (callResult.result === "unreached") comp.status = "unreached";
        else if (callResult.result === "wrong_number") comp.status = "wrong_person";
        else if (callResult.result === "not_interested") comp.status = "not_interested";
      }
      // Update contact status when reached
      if (callResult.result === "introduced" || callResult.result === "meeting") {
        next.contacts = next.contacts.map(c =>
          c.id === callResult.contactId ? { ...c, reached: true, reachedAt: new Date().toISOString() } : c
        );
      }
      // Add WhatsApp to-do if checked
      if (callResult.sendWhatsApp) {
        const today = new Date();
        next.todos = [...(next.todos || []), {
          id: uid(),
          text: `ğŸ“± WhatsApp'tan kiÅŸi kartÄ± ilet â€” ${callResult.contactName} (${callResult.companyName})`,
          todoKey: "whatsapp",
          type: "manual",
          category: "takip",
          priority: 1,
          done: false,
          contactId: callResult.contactId,
          companyId: callResult.companyId,
          targetDate: today.toISOString().split("T")[0],
          targetWeek: getWeekNumber(today),
          targetYear: today.getFullYear(),
          createdAt: new Date().toISOString()
        }];
      }
      return next;
    });
    // Show character profile after call
    setShowCallPanel(false);
    setShowModal("charProfile");
  };

  const [charProfile, setCharProfile] = useState({ communication: "", decisionAuth: "", decisionSpeed: "", arguments: "", competitorOpinion: "", priceSensitivity: "", urgency: "", personalNotes: "", nextCallAsk: "" });

  const saveCharProfile = () => {
    updateData(prev => {
      const existing = prev.contactProfiles.findIndex(p => p.contactId === callResult.contactId);
      const profiles = [...prev.contactProfiles];
      const profile = { ...charProfile, contactId: callResult.contactId, updatedAt: new Date().toISOString() };
      if (existing >= 0) profiles[existing] = { ...profiles[existing], ...profile };
      else profiles.push({ ...profile, id: uid() });

      // Get contact's follow-up info to set target date
      const contact = prev.contacts.find(c => c.id === callResult.contactId);
      let targetDate = null;
      let targetWeek = null;
      let targetYear = null;

      if (contact?.followUpDays) {
        const d = new Date();
        d.setDate(d.getDate() + contact.followUpDays);
        targetDate = d.toISOString().split("T")[0];
        targetWeek = getWeekNumber(d);
        targetYear = d.getFullYear();
      } else if (contact?.nextCallDate) {
        targetDate = contact.nextCallDate;
        targetWeek = getWeekNumber(new Date(contact.nextCallDate));
        targetYear = new Date(contact.nextCallDate).getFullYear();
      }

      // Auto-create to-dos for "SorulmadÄ±" fields
      let todos = [...(prev.todos || [])];
      const sorulmadiLabels = {
        communication: "Ä°letiÅŸim tarzÄ± nasÄ±l?",
        decisionAuth: "Karar verme yetkisi kim?",
        decisionSpeed: "Karar verme hÄ±zÄ± nasÄ±l?",
        arguments: "Ne tÃ¼r argÃ¼manlara aÃ§Ä±k?",
        competitorOpinion: "Rakip hakkÄ±nda ne dÃ¼ÅŸÃ¼nÃ¼yor?",
        priceSensitivity: "Fiyat hassasiyeti nedir?",
        urgency: "Aciliyeti var mÄ±?"
      };

      Object.keys(sorulmadiLabels).forEach(key => {
        if (charProfile[key] === "SorulmadÄ±") {
          // Check if to-do already exists
          const existingTodo = todos.find(t => t.contactId === callResult.contactId && t.profileKey === key && !t.done);
          if (!existingTodo) {
            todos.push({
              id: uid(),
              text: `â“ ${sorulmadiLabels[key]} â€” ${callResult.contactName} (${callResult.companyName})`,
              profileKey: key,
              type: "manual",
              category: "arama",
              priority: 2,
              done: false,
              contactId: callResult.contactId,
              companyId: callResult.companyId,
              targetDate,
              targetWeek,
              targetYear,
              createdAt: new Date().toISOString()
            });
          }
        } else {
          // Remove existing to-do if not "SorulmadÄ±" anymore
          todos = todos.filter(t => !(t.contactId === callResult.contactId && t.profileKey === key && !t.done));
        }
      });

      return { ...prev, contactProfiles: profiles, todos };
    });
    setShowModal(null);
    setCallResult(null);
    setCharProfile({ communication: "", decisionAuth: "", decisionSpeed: "", arguments: "", competitorOpinion: "", priceSensitivity: "", urgency: "", personalNotes: "", nextCallAsk: "" });
  };

  const updateCompanyField = (companyId, field, value) => {
    updateData(prev => ({
      ...prev,
      companies: prev.companies.map(c => c.id === companyId ? { ...c, [field]: value } : c)
    }));
    if (["deviceStatus", "deviceBrand", "contractEndDate"].includes(field)) {
      showSync("Cihaz bilgisi kaydedildi âœ“");
    }
    if (field === "trackingType") {
      const trackingLabels = { target: "Hedef Firma", followup: "DÃ¼zenli Takip" };
      showSync(`Kategori: ${trackingLabels[value] || "KaldÄ±rÄ±ldÄ±"} âœ“`);
    }
    if (field === "status") {
      const statusLabels = { contact_ready: "Kontakt HazÄ±r", no_ready_contact: "HazÄ±r Kontakt Yok", unreached: "UlaÅŸÄ±lamadÄ±", wrong_person: "YanlÄ±ÅŸ KiÅŸi", meeting: "ToplantÄ± AlÄ±ndÄ±", not_interested: "Ä°lgilenmiyor" };
      showSync(`Durum: ${statusLabels[value] || value} âœ“`);
    }
    if (field === "targetWeek") {
      showSync(`Hedef Hafta: H${value} âœ“`);
    }
  };

  const updateContactField = (contactId, field, value) => {
    updateData(prev => {
      const updatedContacts = prev.contacts.map(c => c.id === contactId ? { ...c, [field]: value } : c);
      const contact = updatedContacts.find(c => c.id === contactId);
      let updatedCompanies = prev.companies;
      let updatedTodos = [...(prev.todos || [])];

      // Auto-update pipeline to "contact_ready" if phone added
      if (field === "phone" && value && contact) {
        const company = prev.companies.find(c => c.id === contact.companyId);
        if (company && (!company.status || company.status === "no_ready_contact")) {
          updatedCompanies = prev.companies.map(c =>
            c.id === contact.companyId ? { ...c, status: "contact_ready" } : c
          );
        }
      }

      // Create follow-up to-do when followUpDays is set
      if (field === "followUpDays" && value && contact) {
        const company = prev.companies.find(c => c.id === contact.companyId);
        const targetDate = new Date();
        targetDate.setDate(targetDate.getDate() + value);
        const targetWeek = getWeekNumber(targetDate);
        const targetDateStr = targetDate.toISOString().split("T")[0];
        const targetYear = targetDate.getFullYear();

        // Remove existing follow-up to-do for this contact
        updatedTodos = updatedTodos.filter(t => !(t.contactId === contactId && t.todoKey === "followup_call"));

        // Add new follow-up to-do
        updatedTodos.push({
          id: uid(),
          text: `ğŸ“ Takip aramasÄ± â€” ${contact.name} (${company?.name})`,
          todoKey: "followup_call",
          type: "manual",
          category: "arama",
          priority: 2,
          done: false,
          contactId: contactId,
          companyId: contact.companyId,
          targetDate: targetDateStr,
          targetWeek: targetWeek,
          targetYear: targetYear,
          createdAt: new Date().toISOString()
        });

        // Also update existing "SorulmadÄ±" profile to-dos for this contact
        updatedTodos = updatedTodos.map(t => {
          if (t.contactId === contactId && t.profileKey && !t.done) {
            return { ...t, targetDate: targetDateStr, targetWeek, targetYear };
          }
          return t;
        });
      }

      return { ...prev, contacts: updatedContacts, companies: updatedCompanies, todos: updatedTodos };
    });
  };

  // ---- SEARCH / FILTER ----
  const filteredCompanies = useMemo(() => {
    let result = data.companies;

    // Text search
    if (searchTerm) {
      const term = turkishLower(searchTerm);
      result = result.filter(c => turkishLower(c.name).includes(term));
    }

    // Device filter
    if (companyFilter.device === "none") result = result.filter(c => c.deviceStatus === "none");
    else if (companyFilter.device === "competitor") result = result.filter(c => c.deviceStatus === "competitor");
    else if (companyFilter.device === "unknown") result = result.filter(c => !c.deviceStatus || c.deviceStatus === "unknown");
    else if (companyFilter.device === "ours") result = result.filter(c => c.deviceStatus === "ours");

    // Phone filter
    if (companyFilter.phone === "has_phone") {
      result = result.filter(c => data.contacts.some(ct => ct.companyId === c.id && ct.phone));
    } else if (companyFilter.phone === "no_phone") {
      result = result.filter(c => !data.contacts.some(ct => ct.companyId === c.id && ct.phone));
    }

    // Assigned filter
    if (companyFilter.assigned === "unassigned") result = result.filter(c => !c.targetWeek);
    else if (companyFilter.assigned === "assigned") result = result.filter(c => !!c.targetWeek);

    // Sort by category and priority: Normal Retail > Low Priority Retail > Other
    result = result.sort((a, b) => {
      const aIsOther = a.category === "other";
      const bIsOther = b.category === "other";
      const aIsLow = a.priority === "low";
      const bIsLow = b.priority === "low";

      // Other always at bottom
      if (aIsOther && !bIsOther) return 1;
      if (!aIsOther && bIsOther) return -1;

      // Low priority below normal (but above other)
      if (aIsLow && !bIsLow) return 1;
      if (!aIsLow && bIsLow) return -1;

      // Same category/priority: sort by name
      return turkishLower(a.name).localeCompare(turkishLower(b.name), 'tr');
    });

    return result;
  }, [data.companies, data.contacts, searchTerm, companyFilter]);

  // ============================================================
  // RENDER: WEEKLY VIEW
  // ============================================================

  const weekDates = useMemo(() => getWeekDates(selectedWeek), [selectedWeek]);

  // Filtered companies based on stat card selection
  const displayCompanies = useMemo(() => {
    const targetFirms = sortedWeekCompanies;

    if (weekFilter === "ready") {
      return targetFirms.filter(c => getContacts(c.id).some(ct => ct.phone));
    }
    if (weekFilter === "no_contact") {
      return targetFirms.filter(c => {
        const cts = getContacts(c.id);
        return !cts.some(ct => ct.phone);
      });
    }
    return targetFirms;
  }, [sortedWeekCompanies, weekFilter, getContacts]);

  // Followup companies for the interleaved call list
  const displayFollowups = useMemo(() => {
    return allFollowups.sort((a, b) => {
      const aLogs = getCallLogs(a.id);
      const bLogs = getCallLogs(b.id);
      const aLast = aLogs.length > 0 ? new Date(aLogs[0].date) : new Date(0);
      const bLast = bLogs.length > 0 ? new Date(bLogs[0].date) : new Date(0);
      return aLast - bLast; // en eski aranmÄ±ÅŸ olan en Ã¼stte
    });
  }, [allFollowups, getCallLogs]);

  // Interleaved call order: 1 followup, 1 new target, 1 followup, 1 new target...
  const callOrder = useMemo(() => {
    const ready = displayCompanies.filter(c => getContacts(c.id).some(ct => ct.phone));
    const followReady = displayFollowups.filter(c => getContacts(c.id).some(ct => ct.phone));
    const result = [];
    let ri = 0, fi = 0;
    while (ri < ready.length || fi < followReady.length) {
      if (fi < followReady.length) result.push({ ...followReady[fi], _type: "followup" });
      fi++;
      if (ri < ready.length) result.push({ ...ready[ri], _type: "target" });
      ri++;
    }
    return result;
  }, [displayCompanies, displayFollowups, getContacts]);

  const openCompanyDetail = (company) => {
    setExpandedFirm(company.id);
  };

  const renderCompanyCard = (company, type) => {
    const contacts = getContacts(company.id);
    const contactsWithPhone = contacts.filter(c => c.phone);
    const hasPhone = contactsWithPhone.length > 0;
    const hasAny = contacts.length > 0;
    const statusColor = hasPhone ? colors.green : hasAny ? colors.yellow : colors.red;
    const statusDot = hasPhone ? "ğŸŸ¢" : hasAny ? "ğŸŸ¡" : "ğŸ”´";
    const parent = getParentCompany(company.id);
    const parentContacts = parent ? getContacts(parent.id) : [];

    return (
      <div key={company.id} style={{ ...s.card, borderLeft: `3px solid ${statusColor}`, cursor: "pointer", minWidth: 0 }}>
        <div onClick={() => openCompanyDetail(company)}>
          <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", gap: 6, marginBottom: 4 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 6, minWidth: 0, flex: 1 }}>
              <span style={{ fontSize: 12 }}>{statusDot}</span>
              <span style={{ fontWeight: 700, fontSize: 13, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }} title={company.name}>{company.name}</span>
            </div>
          </div>
          <div style={{ display: "flex", gap: 4, flexWrap: "wrap", marginBottom: 6 }}>
            {hasAny ? (
              <>
                <Badge color={colors.accent} bg={colors.accentDim}>{contacts.length} Kontakt</Badge>
                {hasPhone && <Badge color={colors.green} bg={colors.greenDim}>ğŸ“ {contactsWithPhone.length}</Badge>}
              </>
            ) : (
              <Badge color={colors.red} bg={colors.redDim}>Kontakt Yok</Badge>
            )}
          </div>
          <div style={{ display: "flex", gap: 4, flexWrap: "wrap", marginBottom: 6 }}>
            <StatusBadge status={company.status} hasPhoneContact={hasPhone} />
            {type === "followup" && <Badge color={colors.orange} bg="#3d1e08">Takip</Badge>}
          </div>
          {parent && <div style={{ fontSize: 10, color: colors.textMuted, marginBottom: 4 }}>â†³ {parent.name}</div>}
          {company.deviceStatus && company.deviceStatus !== "unknown" && (
            <div style={{ fontSize: 10, color: company.deviceStatus === "competitor" ? colors.red : company.deviceStatus === "none" ? colors.green : colors.accent, marginTop: 4 }}>
              {company.deviceStatus === "none" ? "Cihaz Yok" : company.deviceStatus === "ours" ? "Bizde" : company.deviceStatus === "competitor" ? `Cihaz Var${company.deviceBrand ? ` / ${company.deviceBrand}` : ""}` : ""}
            </div>
          )}
        </div>
      </div>
    );
  };

  const renderWeeklyView = () => (
    <div>
      {/* Week Selector with Date Range */}
      <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 16 }}>
        <button style={s.btn()} onClick={() => { setSelectedWeek(w => Math.max(1, w - 1)); setWeekFilter("all"); }}>â—€</button>
        <div>
          <span style={{ fontSize: 16, fontWeight: 700 }}>Hafta {selectedWeek}</span>
          <span style={{ fontSize: 12, color: colors.textMuted, marginLeft: 8 }}>{weekDates.label}, {currentYear}</span>
        </div>
        <button style={s.btn()} onClick={() => { setSelectedWeek(w => Math.min(53, w + 1)); setWeekFilter("all"); }}>â–¶</button>
        {selectedWeek !== currentWeek && <button style={s.btn("primary")} onClick={() => { setSelectedWeek(currentWeek); setWeekFilter("all"); }}>Bu Hafta</button>}
      </div>

      {/* Clickable Stats Row */}
      <div style={{ display: "flex", gap: 10, flexWrap: "wrap", marginBottom: 16 }}>
        {[
          { key: "all", label: "Hedef Firma", value: stats.weekTargets, color: colors.accent },
          { key: "ready", label: "Aramaya HazÄ±r", value: stats.weekReady, color: colors.green },
          { key: "no_contact", label: "Kontakt Eksik", value: stats.weekNoContact, color: colors.red },
          { key: "calls", label: "YapÄ±lan Arama", value: stats.weekCalls, color: colors.yellow },
          { key: "meetings", label: "ToplantÄ± AlÄ±nan", value: stats.weekMeetings, color: colors.purple },
          { key: "followup", label: "DÃ¼zenli Takip", value: stats.weekFollowups, color: colors.orange },
        ].map(st => (
          <div
            key={st.key}
            onClick={() => ["all", "ready", "no_contact", "followup"].includes(st.key) ? setWeekFilter(st.key) : null}
            style={{
              ...s.statCard(st.color),
              cursor: ["all", "ready", "no_contact", "followup"].includes(st.key) ? "pointer" : "default",
              outline: weekFilter === st.key ? `2px solid ${st.color}` : "none",
              outlineOffset: 2,
              opacity: weekFilter === st.key ? 1 : 0.8,
              transition: "all 0.15s",
            }}
          >
            <div style={{ fontSize: 22, fontWeight: 800, color: st.color }}>{st.value}</div>
            <div style={{ fontSize: 11, color: colors.textMuted, marginTop: 2 }}>{st.label}</div>
          </div>
        ))}
      </div>

      {/* TWO COLUMN LAYOUT: Hedef (left) + DÃ¼zenli Takip (right) */}
      <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(400px, 1fr))", gap: 20 }}>
        {/* LEFT: Hedef Firmalar */}
        <div>
          <div style={{ fontSize: 14, fontWeight: 700, color: colors.accent, marginBottom: 12, display: "flex", alignItems: "center", gap: 8 }}>
            ğŸ¯ Hedef Firmalar ({displayCompanies.length})
            {weekFilter !== "all" && (
              <button style={{ ...s.btn(), padding: "2px 8px", fontSize: 10 }} onClick={() => setWeekFilter("all")}>âœ•</button>
            )}
          </div>
          {displayCompanies.length === 0 ? (
            <div style={{ ...s.card, textAlign: "center", color: colors.textMuted, padding: 20, fontSize: 12 }}>Bu haftada henÃ¼z firma yok.</div>
          ) : (
            <div style={{ display: "grid", gridTemplateColumns: "repeat(2, 1fr)", gap: 10 }}>
              {displayCompanies.map(c => renderCompanyCard(c, "target"))}
            </div>
          )}
        </div>

        {/* RIGHT: DÃ¼zenli Takip */}
        <div>
          <div style={{ fontSize: 14, fontWeight: 700, color: colors.orange, marginBottom: 12, display: "flex", alignItems: "center", gap: 8 }}>
            ğŸ”„ DÃ¼zenli Takip ({allFollowups.length})
          </div>
          {allFollowups.length === 0 ? (
            <div style={{ ...s.card, textAlign: "center", color: colors.textMuted, padding: 20, fontSize: 12 }}>DÃ¼zenli takipte firma yok.</div>
          ) : (
            <div style={{ display: "grid", gridTemplateColumns: "repeat(2, 1fr)", gap: 10 }}>
              {displayFollowups.map(c => renderCompanyCard(c, "followup"))}
            </div>
          )}
        </div>
      </div>
    </div>
  );

  // ============================================================
  // RENDER: DASHBOARD
  // ============================================================

  const renderDashboard = () => {
    const trackingCounts = { target: 0, followup: 0, none: 0 };
    const statusCounts = {};
    data.companies.forEach(c => {
      trackingCounts[c.trackingType || "none"]++;
      const effectiveStatus = c.status || (data.contacts.some(ct => ct.companyId === c.id && ct.phone) ? "contact_ready" : "no_ready_contact");
      statusCounts[effectiveStatus] = (statusCounts[effectiveStatus] || 0) + 1;
    });
    const parentComps = data.companies.filter(c => c.isParent);

    return (
      <div>
        <div style={{ fontSize: 18, fontWeight: 800, marginBottom: 16 }}>Dashboard</div>

        {/* Main Stats */}
        <div style={{ display: "flex", gap: 10, flexWrap: "wrap", marginBottom: 20 }}>
          <StatCard label="Toplam Firma" value={stats.totalCompanies} color={colors.accent} />
          <StatCard label="Cihaz Yok" value={stats.noDevice} color={colors.green} sub="Hedef mÃ¼ÅŸteri" />
          <StatCard label="Cihaz Var" value={stats.hasDevice} color={colors.red} sub="Rakip mevcut" />
          <StatCard label="Toplam Kontakt" value={stats.totalContacts} color={colors.yellow} />
          <StatCard label="Telefon Var" value={stats.withPhone} color={colors.green} />
          <StatCard label="Email Var" value={stats.withEmail} color={colors.yellow} />
          <StatCard label="Sadece LinkedIn" value={stats.onlyLinkedin} color={colors.accent} />
          <StatCard label="Ã‡atÄ± Firma" value={stats.parentCompanies} color={colors.purple} />
        </div>

        {/* Pipeline Distribution */}
        <div style={s.card}>
          <div style={{ fontSize: 13, fontWeight: 700, marginBottom: 12 }}>Pipeline DaÄŸÄ±lÄ±mÄ±</div>
          <div style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
            {Object.entries(pipelineCounts).map(([stage, count]) => (
              <div key={stage} style={{ display: "flex", alignItems: "center", gap: 6 }}>
                <PipelineBadge stage={stage} />
                <span style={{ fontWeight: 700, fontSize: 14 }}>{count}</span>
              </div>
            ))}
          </div>
        </div>

        {/* Parent Companies */}
        {parentComps.length > 0 && (
          <div style={s.card}>
            <div style={{ fontSize: 13, fontWeight: 700, marginBottom: 12 }}>Ã‡atÄ± Firmalar</div>
            {parentComps.map(pc => {
              const children = getChildCompanies(pc.id);
              const pcContacts = getContacts(pc.id);
              return (
                <div key={pc.id} style={{ marginBottom: 10, paddingBottom: 10, borderBottom: `1px solid ${colors.border}` }}>
                  <div style={{ fontWeight: 700, display: "flex", alignItems: "center", gap: 8 }}>
                    <BuildingIcon size={14} color={colors.purple} />
                    {pc.name}
                    <Badge color={colors.purple} bg="#2d1a4e">{children.length} alt firma</Badge>
                    <Badge color={colors.textMuted} bg={colors.surfaceHover}>{pcContacts.length} kontakt</Badge>
                  </div>
                  <div style={{ marginLeft: 22, marginTop: 4 }}>
                    {children.map(ch => (
                      <span key={ch.id} style={{ fontSize: 11, color: colors.textMuted, marginRight: 12 }}>
                        â†’ {ch.name} <PipelineBadge stage={ch.pipeline} />
                      </span>
                    ))}
                  </div>
                </div>
              );
            })}
          </div>
        )}

        {/* Contact Gap Report */}
        <div style={s.card}>
          <div style={{ fontSize: 13, fontWeight: 700, marginBottom: 12, color: colors.red }}>Kontakt Eksik Firmalar</div>
          <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>
            {data.companies.filter(c => !data.contacts.some(ct => ct.companyId === c.id)).slice(0, 15).map(c => (
              <div key={c.id} style={{ fontSize: 12, display: "flex", alignItems: "center", gap: 8 }}>
                <span style={{ color: colors.red }}>â—</span>
                <span>{c.name}</span>
                <StatusBadge status={c.status} hasPhoneContact={false} />
              </div>
            ))}
          </div>
        </div>
      </div>
    );
  };

  // ============================================================
  // RENDER: ALL COMPANIES
  // ============================================================

  const assignToWeek = (companyId, week) => {
    updateData(prev => ({
      ...prev,
      companies: prev.companies.map(c => c.id === companyId ? { ...c, targetWeek: week, targetYear: currentYear } : c)
    }));
    setTargetWeekPicker(null);
  };

  const renderAllCompanies = () => {
    const filterPresets = [
      { label: "TÃ¼mÃ¼", filter: { device: "all", phone: "all", assigned: "all" }, color: colors.textMuted },
      { label: "ğŸ¯ Cihaz Yok (Hedef)", filter: { device: "none", phone: "all", assigned: "all" }, color: colors.green },
      { label: "ğŸ“ Telefon Var", filter: { device: "all", phone: "has_phone", assigned: "all" }, color: colors.green },
      { label: "âŒ Telefon Yok", filter: { device: "all", phone: "no_phone", assigned: "all" }, color: colors.red },
      { label: "ğŸ¯ğŸ“ Cihaz Yok + Tel Var", filter: { device: "none", phone: "has_phone", assigned: "all" }, color: colors.accent },
      { label: "â³ Haftaya AtanmamÄ±ÅŸ", filter: { device: "all", phone: "all", assigned: "unassigned" }, color: colors.orange },
      { label: "âš”ï¸ Cihaz Var (Rakip)", filter: { device: "competitor", phone: "all", assigned: "all" }, color: colors.red },
    ];

    const isPresetActive = (preset) =>
      companyFilter.device === preset.filter.device &&
      companyFilter.phone === preset.filter.phone &&
      companyFilter.assigned === preset.filter.assigned;

    return (
      <div>
        {/* Header */}
        <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 12 }}>
          <div style={{ fontSize: 18, fontWeight: 800 }}>Firmalar</div>
          <div style={{ flex: 1, maxWidth: 300, position: "relative" }}>
            <SearchIcon size={14} color={colors.textDim} style={{ position: "absolute", left: 8, top: 8 }} />
            <input style={{ ...s.input, paddingLeft: 28 }} placeholder="Firma ara..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
          </div>
          <span style={{ fontSize: 12, color: colors.textMuted }}>{filteredCompanies.length} / {data.companies.length} firma</span>
        </div>

        {/* Quick Filter Presets */}
        <div style={{ display: "flex", gap: 4, flexWrap: "wrap", marginBottom: 12 }}>
          {filterPresets.map((p, i) => (
            <button
              key={i}
              style={{
                ...s.btn(isPresetActive(p) ? "primary" : "default"),
                fontSize: 11,
                padding: "4px 10px",
                outline: isPresetActive(p) ? `2px solid ${p.color}` : "none",
                outlineOffset: 1,
              }}
              onClick={() => setCompanyFilter(p.filter)}
            >
              {p.label}
            </button>
          ))}
        </div>

        {/* Table */}
        <div style={{ overflowX: "auto" }}>
          <table style={{ ...s.table, tableLayout: "fixed", width: "100%" }}>
            <thead>
              <tr>
                <th style={{ ...s.th, width: "16%" }}>Firma</th>
                <th style={{ ...s.th, width: "10%" }}>Ã‡atÄ±</th>
                <th style={{ ...s.th, width: "8%" }}>Cihaz</th>
                <th style={{ ...s.th, width: "10%" }}>Durum</th>
                <th style={{ ...s.th, width: "8%" }}>Kontakt</th>
                <th style={{ ...s.th, width: "8%" }}>Hedef</th>
                <th style={{ ...s.th, width: "8%" }}>Hafta</th>
                <th style={{ ...s.th, width: "8%" }}>Takip</th>
                <th style={{ ...s.th, width: "8%" }}>Kategori</th>
                <th style={{ ...s.th, width: "8%" }}>Ã–ncelik</th>
              </tr>
            </thead>
            <tbody>
              {filteredCompanies.map(c => {
                const cts = getContacts(c.id);
                const parent = getParentCompany(c.id);
                const hasPhone = cts.some(ct => ct.phone);
                const hasEmail = cts.some(ct => ct.email);
                const isAssigned = !!c.targetWeek;
                return (
                  <tr key={c.id} style={{ background: isAssigned ? "rgba(59,130,246,0.03)" : "transparent" }}>
                    <td style={{ ...s.td, fontWeight: 600 }}>
                      <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                        <span style={{ color: hasPhone ? colors.green : cts.length > 0 ? colors.yellow : colors.red, fontSize: 8 }}>â—</span>
                        <span style={{ cursor: "pointer" }} onClick={() => { setExpandedFirm(c.id); if (c.targetWeek) { setActiveTab("weekly"); setSelectedWeek(c.targetWeek); } }}>{c.name}</span>
                      </div>
                    </td>
                    <td style={s.td}>
                      <select
                        style={{ ...s.select, fontSize: 11, padding: "3px 6px", width: 80, color: c.isParent ? colors.purple : c.parentId ? colors.purple : colors.textDim, background: "transparent", border: `1px solid ${colors.border}` }}
                        value={c.isParent ? "_self" : c.parentId || ""}
                        title={c.isParent ? "Kendisi Ã§atÄ±" : c.parentId ? (data.companies.find(p => p.id === c.parentId)?.name || "") : "Yok"}
                        onChange={(e) => {
                          const val = e.target.value;
                          if (val === "_self") {
                            updateCompanyField(c.id, "isParent", true);
                            updateCompanyField(c.id, "parentId", null);
                          } else if (val === "") {
                            updateCompanyField(c.id, "isParent", false);
                            updateCompanyField(c.id, "parentId", null);
                          } else {
                            updateCompanyField(c.id, "isParent", false);
                            updateCompanyField(c.id, "parentId", val);
                          }
                        }}
                      >
                        <option value="">â€” Yok â€”</option>
                        <option value="_self">ğŸ¢ Kendisi Ã§atÄ±</option>
                        {data.companies.filter(p => p.isParent && p.id !== c.id).map(p => (
                          <option key={p.id} value={p.id}>â†³ {p.name}</option>
                        ))}
                      </select>
                    </td>
                    <td style={s.td}><DeviceBadge status={c.deviceStatus} brand={c.deviceBrand}/></td>
                    <td style={s.td}><StatusBadge status={c.status} hasPhoneContact={hasPhone}/></td>
                    <td style={s.td}>
                      <div style={{ display: "flex", gap: 3, alignItems: "center" }}>
                        {hasPhone && <Badge color={colors.green} bg={colors.greenDim}>ğŸ“ {cts.filter(ct=>ct.phone).length}</Badge>}
                        {hasEmail && <Badge color={colors.yellow} bg={colors.yellowDim}><MailIcon size={12}/> {cts.filter(ct=>ct.email).length}</Badge>}
                        {cts.length > 0 && !hasPhone && !hasEmail && <Badge color={colors.accent} bg={colors.accentDim}>ğŸ”— {cts.length}</Badge>}
                        {cts.length === 0 && <Badge color={colors.red} bg={colors.redDim}>0</Badge>}
                      </div>
                    </td>
                    <td style={s.td}>
                      <button
                        style={{
                          ...s.btn(c.trackingType === "target" ? "primary" : "default"),
                          padding: "3px 10px",
                          fontSize: 11,
                          opacity: c.trackingType === "target" ? 1 : 0.5
                        }}
                        onClick={() => {
                          if (c.trackingType === "target") {
                            updateCompanyField(c.id, "trackingType", null);
                            updateCompanyField(c.id, "targetWeek", null);
                          } else {
                            updateCompanyField(c.id, "trackingType", "target");
                            updateCompanyField(c.id, "targetWeek", currentWeek);
                            updateCompanyField(c.id, "targetYear", currentYear);
                          }
                        }}
                        title={c.trackingType === "target" ? "Hedeften Ã§Ä±kar" : "Hedef olarak ata"}
                      >
                        {c.trackingType === "target" ? "âœ“ Hedef" : "Hedef"}
                      </button>
                    </td>
                    <td style={s.td}>
                      {c.trackingType === "target" ? (
                        <select
                          style={{ ...s.select, fontSize: 11, padding: "3px 6px", background: colors.accentDim, color: colors.accent }}
                          value={c.targetWeek || currentWeek}
                          onChange={(e) => {
                            updateCompanyField(c.id, "targetWeek", parseInt(e.target.value));
                            updateCompanyField(c.id, "targetYear", currentYear);
                          }}
                        >
                          {[...Array(6)].map((_, i) => (
                            <option key={i} value={currentWeek + i}>H{currentWeek + i}{i === 0 ? " (Bu)" : ""}</option>
                          ))}
                        </select>
                      ) : (
                        <span style={{ fontSize: 11, color: colors.textDim }}>â€”</span>
                      )}
                    </td>
                    <td style={s.td}>
                      <button
                        style={{
                          ...s.btn(c.trackingType === "followup" ? "success" : "default"),
                          padding: "3px 10px",
                          fontSize: 11
                        }}
                        onClick={() => updateCompanyField(c.id, "trackingType", c.trackingType === "followup" ? null : "followup")}
                        title={c.trackingType === "followup" ? "DÃ¼zenli takipten Ã§Ä±kar" : "DÃ¼zenli takibe ekle"}
                      >
                        {c.trackingType === "followup" ? "âœ“ Takipte" : "+ Takip"}
                      </button>
                    </td>
                    <td style={s.td}>
                      <select
                        style={{ ...s.select, fontSize: 11, padding: "3px 6px", background: c.category === "other" ? colors.redDim : c.category === "health" ? colors.greenDim : "transparent", color: c.category === "other" ? colors.red : c.category === "health" ? colors.green : colors.textMuted }}
                        value={c.category || "retail"}
                        onChange={(e) => updateCompanyField(c.id, "category", e.target.value)}
                      >
                        <option value="retail">Perakende</option>
                        <option value="health">SaÄŸlÄ±k</option>
                        <option value="other">Other</option>
                      </select>
                    </td>
                    <td style={s.td}>
                      <select
                        style={{ ...s.select, fontSize: 11, padding: "3px 6px", background: c.priority === "low" ? colors.yellowDim : "transparent", color: c.priority === "low" ? colors.yellow : colors.textMuted }}
                        value={c.priority || "normal"}
                        onChange={(e) => updateCompanyField(c.id, "priority", e.target.value)}
                      >
                        <option value="normal">Normal</option>
                        <option value="low">DÃ¼ÅŸÃ¼k</option>
                      </select>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      </div>
    );
  };

  // ============================================================
  // RENDER: COMPETITORS
  // ============================================================

  const [newCompetitor, setNewCompetitor] = useState({ name: "", priceStrategy: "monthly", priceMin: "", priceMax: "", strength: "", weakness: "" });

  const addCompetitor = () => {
    if (!newCompetitor.name.trim()) return;
    updateData(prev => ({
      ...prev,
      competitors: [...(prev.competitors || []), { ...newCompetitor, id: uid(), createdAt: new Date().toISOString() }]
    }));
    setNewCompetitor({ name: "", priceStrategy: "monthly", priceMin: "", priceMax: "", strength: "", weakness: "" });
    showSync("Rakip firma eklendi âœ“");
  };

  const deleteCompetitor = (id) => {
    updateData(prev => ({
      ...prev,
      competitors: (prev.competitors || []).filter(c => c.id !== id)
    }));
    showSync("Rakip firma silindi âœ“");
  };

  const renderCompetitors = () => {
    const competitors = data.competitors || [];

    // AVM'den gelen notlar (deviceBrand olan ama competitors'ta olmayan)
    const competitorNames = competitors.map(c => c.name.toLowerCase());
    const avmNotes = [];
    data.companies.filter(c => c.deviceStatus === "competitor" && c.deviceBrand).forEach(c => {
      if (!competitorNames.includes(c.deviceBrand.toLowerCase())) {
        avmNotes.push({ brand: c.deviceBrand, company: c });
      }
    });

    return (
      <div>
        <div style={{ fontSize: 18, fontWeight: 800, marginBottom: 16 }}>Rakip Analizi</div>

        {/* Rakip Firma Ekleme Formu */}
        <div style={{ ...s.card, marginBottom: 16 }}>
          <div style={{ fontSize: 13, fontWeight: 700, marginBottom: 12 }}>Yeni Rakip Firma Ekle</div>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr 1fr 1fr 1fr auto", gap: 8, alignItems: "end" }}>
            <div>
              <div style={{ fontSize: 10, color: colors.textMuted, marginBottom: 4 }}>Firma AdÄ± *</div>
              <input style={s.input} value={newCompetitor.name} onChange={e => setNewCompetitor({ ...newCompetitor, name: e.target.value })} placeholder="Rakip firma adÄ±..." />
            </div>
            <div>
              <div style={{ fontSize: 10, color: colors.textMuted, marginBottom: 4 }}>Fiyat Stratejisi</div>
              <select style={s.select} value={newCompetitor.priceStrategy} onChange={e => setNewCompetitor({ ...newCompetitor, priceStrategy: e.target.value })}>
                <option value="monthly">AylÄ±k Fee</option>
                <option value="onetime">Tek Seferlik</option>
              </select>
            </div>
            <div>
              <div style={{ fontSize: 10, color: colors.textMuted, marginBottom: 4 }}>Min Fiyat (USD)</div>
              <input style={s.input} type="number" value={newCompetitor.priceMin} onChange={e => setNewCompetitor({ ...newCompetitor, priceMin: e.target.value })} placeholder="0" />
            </div>
            <div>
              <div style={{ fontSize: 10, color: colors.textMuted, marginBottom: 4 }}>Max Fiyat (USD)</div>
              <input style={s.input} type="number" value={newCompetitor.priceMax} onChange={e => setNewCompetitor({ ...newCompetitor, priceMax: e.target.value })} placeholder="0" />
            </div>
            <div>
              <div style={{ fontSize: 10, color: colors.textMuted, marginBottom: 4 }}>En GÃ¼Ã§lÃ¼ Ã–zellik</div>
              <input style={s.input} value={newCompetitor.strength} onChange={e => setNewCompetitor({ ...newCompetitor, strength: e.target.value })} placeholder="..." />
            </div>
            <div>
              <div style={{ fontSize: 10, color: colors.textMuted, marginBottom: 4 }}>En ZayÄ±f Ã–zellik</div>
              <input style={s.input} value={newCompetitor.weakness} onChange={e => setNewCompetitor({ ...newCompetitor, weakness: e.target.value })} placeholder="..." />
            </div>
            <button style={s.btn("primary")} onClick={addCompetitor} disabled={!newCompetitor.name.trim()}>Ekle</button>
          </div>
        </div>

        {/* Rakip Firma Listesi */}
        {competitors.length > 0 && (
          <div style={{ ...s.card, marginBottom: 16 }}>
            <div style={{ fontSize: 13, fontWeight: 700, marginBottom: 12 }}>Rakip Firmalar ({competitors.length})</div>
            <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
              {competitors.map(c => {
                const companiesWithThis = data.companies.filter(co => co.deviceBrand?.toLowerCase() === c.name.toLowerCase());
                return (
                  <div key={c.id} style={{ display: "grid", gridTemplateColumns: "1.5fr 1fr 1fr 1fr 1fr 80px auto", gap: 8, alignItems: "center", padding: "8px 12px", background: colors.surfaceHover, borderRadius: 6 }}>
                    <div>
                      <span style={{ fontWeight: 600, color: colors.red }}>{c.name}</span>
                      {companiesWithThis.length > 0 && <Badge color={colors.red} bg={colors.redDim} style={{ marginLeft: 8 }}>{companiesWithThis.length} firma</Badge>}
                    </div>
                    <span style={{ fontSize: 11, color: colors.textMuted }}>{c.priceStrategy === "monthly" ? "AylÄ±k Fee" : "Tek Seferlik"}</span>
                    <span style={{ fontSize: 11, color: colors.yellow }}>{c.priceMin && c.priceMax ? `$${c.priceMin} - $${c.priceMax}` : "â€”"}</span>
                    <span style={{ fontSize: 11, color: colors.green }} title={c.strength}>ğŸ’ª {c.strength || "â€”"}</span>
                    <span style={{ fontSize: 11, color: colors.orange }} title={c.weakness}>âš ï¸ {c.weakness || "â€”"}</span>
                    <span style={{ fontSize: 10, color: colors.textDim }}>{companiesWithThis.length} mÃ¼ÅŸteri</span>
                    <button style={{ ...s.btn("danger"), padding: "4px 8px", fontSize: 10 }} onClick={() => deleteCompetitor(c.id)}>ğŸ—‘ï¸</button>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* AVM'den Gelen Notlar */}
        {avmNotes.length > 0 && (
          <div style={{ ...s.card }}>
            <div style={{ fontSize: 13, fontWeight: 700, marginBottom: 12, color: colors.textMuted }}>AVM Excel'den Gelen Notlar ({avmNotes.length})</div>
            <div style={{ fontSize: 11, color: colors.textDim, marginBottom: 12 }}>Bu notlarÄ± ilgili rakip firmaya atayÄ±n veya yeni rakip firma olarak ekleyin.</div>
            <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
              {avmNotes.map((note, i) => (
                <div key={i} style={{ display: "flex", alignItems: "center", gap: 8, padding: "6px 10px", background: colors.surface, borderRadius: 4, border: `1px solid ${colors.border}` }}>
                  <span style={{ fontSize: 12, flex: 1 }}>{note.brand}</span>
                  <span style={{ fontSize: 10, color: colors.textDim }}>({note.company.name})</span>
                  <select
                    style={{ ...s.select, fontSize: 11, padding: "3px 6px" }}
                    value=""
                    onChange={(e) => {
                      if (e.target.value) {
                        updateCompanyField(note.company.id, "deviceBrand", e.target.value);
                      }
                    }}
                  >
                    <option value="">Rakip SeÃ§...</option>
                    {competitors.map(c => (
                      <option key={c.id} value={c.name}>{c.name}</option>
                    ))}
                  </select>
                </div>
              ))}
            </div>
          </div>
        )}

        {competitors.length === 0 && avmNotes.length === 0 && (
          <div style={{ ...s.card, color: colors.textMuted, textAlign: "center" }}>HenÃ¼z rakip firma eklenmedi.</div>
        )}
      </div>
    );
  };

  // ============================================================
  // RENDER: TO-DO LIST
  // ============================================================

  const renderTodos = () => {
    // Auto-generate todos from pipeline state
    const autoTodos = [];

    data.companies.forEach(c => {
      const cts = getContacts(c.id);
      const hasPhone = cts.some(ct => ct.phone);
      const logs = getCallLogs(c.id);
      const lastLog = logs[0];

      if (c.trackingType === "target" && cts.length === 0) {
        autoTodos.push({ id: `auto-${c.id}-contact`, type: "auto", priority: 1, text: `Kontakt bul: ${c.name}`, company: c.name, companyId: c.id, category: "kontakt" });
      }
      if (c.trackingType === "target" && cts.length > 0 && !hasPhone) {
        autoTodos.push({ id: `auto-${c.id}-phone`, type: "auto", priority: 2, text: `Telefon bul: ${c.name} (${cts.length} kontakt var, tel yok)`, company: c.name, companyId: c.id, category: "kontakt" });
      }
      if ((c.status === "contact_ready" || (!c.status && hasPhone)) && c.targetWeek === selectedWeek) {
        autoTodos.push({ id: `auto-${c.id}-call`, type: "auto", priority: 1, text: `Ara: ${c.name}`, company: c.name, companyId: c.id, category: "arama" });
      }
      if (c.status === "unreached") {
        autoTodos.push({ id: `auto-${c.id}-retry`, type: "auto", priority: 3, text: `Tekrar ara: ${c.name}`, company: c.name, companyId: c.id, category: "arama" });
      }
      if (c.trackingType === "followup") {
        const daysSince = lastLog ? Math.floor((Date.now() - new Date(lastLog.date)) / 86400000) : 999;
        autoTodos.push({ id: `auto-${c.id}-followup`, type: "auto", priority: daysSince > 7 ? 1 : 3, text: `Takip aramasÄ±: ${c.name} (${daysSince} gÃ¼n oldu)`, company: c.name, companyId: c.id, category: "takip" });
      }
      if (c.status === "meeting") {
        autoTodos.push({ id: `auto-${c.id}-meeting`, type: "auto", priority: 1, text: `ToplantÄ±: ${c.name}`, company: c.name, companyId: c.id, category: "toplantÄ±" });
      }
    });

    // Combine auto + manual todos
    const manualTodos = data.todos || [];
    const allTodos = [...autoTodos, ...manualTodos].filter(t => !t.done);

    // Separate: with targetWeek vs without
    const withWeek = allTodos.filter(t => t.targetWeek).sort((a, b) => {
      // Sort by week ascending (earlier weeks first)
      if (a.targetWeek !== b.targetWeek) return a.targetWeek - b.targetWeek;
      // Then by date
      if (a.targetDate && b.targetDate && a.targetDate !== b.targetDate) {
        return a.targetDate.localeCompare(b.targetDate);
      }
      return (a.priority || 99) - (b.priority || 99);
    });

    const withoutWeek = allTodos.filter(t => !t.targetWeek).sort((a, b) => {
      // Sort by createdAt descending (newest first)
      const dateA = a.createdAt ? new Date(a.createdAt).getTime() : 0;
      const dateB = b.createdAt ? new Date(b.createdAt).getTime() : 0;
      return dateB - dateA;
    });

    const doneTodos = manualTodos.filter(t => t.done);

    // Group by week - dated ones first, then unassigned
    const byWeek = {};
    withWeek.forEach(t => {
      if (!byWeek[t.targetWeek]) byWeek[t.targetWeek] = [];
      byWeek[t.targetWeek].push(t);
    });
    if (withoutWeek.length > 0) {
      byWeek["unassigned"] = withoutWeek;
    }

    return (
      <div>
        <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 16 }}>
          <div style={{ fontSize: 18, fontWeight: 800 }}>To-Do ({allTodos.length})</div>
          <button style={s.btn("primary")} onClick={() => {
            const text = prompt("Yeni to-do:");
            if (text) updateData(prev => ({ ...prev, todos: [...(prev.todos || []), { id: uid(), text, type: "manual", category: "genel", priority: 5, done: false, createdAt: new Date().toISOString() }] }));
          }}><PlusIcon size={14}/> Ekle</button>
        </div>

        {Object.entries(byWeek)
          .sort((a, b) => {
            if (a[0] === "unassigned") return 1;
            if (b[0] === "unassigned") return -1;
            return parseInt(a[0]) - parseInt(b[0]);
          })
          .map(([week, items]) => (
            <div key={week} style={{ marginBottom: 20 }}>
              <div style={{ fontSize: 13, fontWeight: 700, color: week === "unassigned" ? colors.textDim : week == currentWeek ? colors.green : colors.accent, marginBottom: 8 }}>
                {week === "unassigned" ? "ğŸ“Œ Hafta AtanmamÄ±ÅŸ" : `ğŸ“… Hafta ${week}${week == currentWeek ? " (Bu Hafta)" : ""}`} ({items.length})
              </div>
              {items.map(todo => {
                const dateStr = todo.targetDate ? new Date(todo.targetDate).toLocaleDateString("tr", { day: "numeric", month: "short" }) : null;
                const isToday = todo.targetDate === new Date().toISOString().split("T")[0];
                return (
                  <div key={todo.id} style={{ ...s.card, padding: "10px 14px", display: "flex", alignItems: "center", gap: 10, marginBottom: 6 }}>
                    {todo.type === "manual" && (
                      <input type="checkbox" checked={false} onChange={() => {
                        updateData(prev => ({
                          ...prev,
                          todos: prev.todos.map(t => t.id === todo.id ? { ...t, done: true } : t)
                        }));
                      }} />
                    )}
                    <span style={{ fontSize: 10, color: todo.priority <= 1 ? colors.red : todo.priority <= 2 ? colors.orange : colors.textDim, fontWeight: 700, minWidth: 16 }}>
                      {todo.priority <= 1 ? "!" : todo.priority <= 2 ? "â€¢" : ""}
                    </span>
                    <span style={{ flex: 1, fontSize: 12 }}>{todo.text}</span>
                    {todo.profileKey && <Badge color={colors.yellow} bg={colors.yellowDim}>â“</Badge>}
                    {todo.type === "auto" && <Badge color={colors.textDim} bg={colors.surfaceHover}>otomatik</Badge>}
                    {todo.type === "manual" && (
                      <>
                        {/* Show date badge if date is set, otherwise show week picker */}
                        {todo.targetDate ? (
                          <span style={{ fontSize: 11, fontWeight: 600, color: isToday ? colors.green : colors.accent, background: isToday ? colors.greenDim : colors.accentDim, padding: "3px 8px", borderRadius: 4 }}>
                            ğŸ“… {isToday ? "BugÃ¼n" : dateStr}
                          </span>
                        ) : (
                          <select
                            style={{ ...s.select, fontSize: 10, padding: "2px 4px", width: 55, background: todo.targetWeek ? colors.accentDim : "transparent", color: todo.targetWeek ? colors.accent : colors.textDim }}
                            value={todo.targetWeek || ""}
                            onChange={(e) => {
                              const newWeek = e.target.value ? parseInt(e.target.value) : null;
                              updateData(prev => ({
                                ...prev,
                                todos: prev.todos.map(t => t.id === todo.id ? { ...t, targetWeek: newWeek, targetYear: newWeek ? currentYear : null } : t)
                              }));
                            }}
                          >
                            <option value="">â€”</option>
                            {[...Array(8)].map((_, i) => <option key={i} value={currentWeek + i}>H{currentWeek + i}</option>)}
                          </select>
                        )}
                        <button style={{ ...s.btn("danger"), padding: "2px 6px" }} onClick={() => {
                          updateData(prev => ({ ...prev, todos: prev.todos.filter(t => t.id !== todo.id) }));
                        }}><TrashIcon size={10}/></button>
                      </>
                    )}
                  </div>
                );
              })}
            </div>
          ))}

        {/* Tamamlananlar */}
        {doneTodos.length > 0 && (
          <div style={{ marginBottom: 16 }}>
            <div style={{ fontSize: 13, fontWeight: 700, color: colors.green, marginBottom: 8 }}>âœ… Tamamlanan ({doneTodos.length})</div>
            {doneTodos.slice(0, 10).map(todo => (
              <div key={todo.id} style={{ ...s.card, padding: "8px 14px", display: "flex", alignItems: "center", gap: 10, opacity: 0.5, marginBottom: 4 }}>
                <input type="checkbox" checked={true} onChange={() => {
                  updateData(prev => ({
                    ...prev,
                    todos: prev.todos.map(t => t.id === todo.id ? { ...t, done: false } : t)
                  }));
                }} />
                <span style={{ flex: 1, fontSize: 12, textDecoration: "line-through" }}>{todo.text}</span>
                <button style={{ ...s.btn("danger"), padding: "2px 6px" }} onClick={() => {
                  updateData(prev => ({ ...prev, todos: prev.todos.filter(t => t.id !== todo.id) }));
                }}><TrashIcon size={10}/></button>
              </div>
            ))}
            {doneTodos.length > 10 && <div style={{ fontSize: 11, color: colors.textDim, marginTop: 4 }}>+{doneTodos.length - 10} daha...</div>}
          </div>
        )}

        {allTodos.length === 0 && (
          <div style={{ ...s.card, textAlign: "center", color: colors.textMuted, padding: 30 }}>
            YapÄ±lacak bir ÅŸey yok! Firma ve kontakt eklediÄŸinde otomatik to-do'lar oluÅŸacak.
          </div>
        )}
      </div>
    );
  };

  // ============================================================
  // ACTIONS PAGE
  // ============================================================

  const renderActions = () => {
    // Collect all actions from different sources
    const actions = [];

    // 1. Call logs - each call is an action
    data.callLogs.forEach(log => {
      const company = data.companies.find(c => c.id === log.companyId);
      const contact = data.contacts.find(c => c.id === log.contactId);
      const resultLabels = {
        meeting: "âœ… ToplantÄ± AlÄ±ndÄ±",
        introduced: "ğŸ¤ UlaÅŸÄ±ldÄ±",
        has_device: "ğŸ”´ Cihaz Var",
        unreached: "âŒ UlaÅŸÄ±lamadÄ±",
        wrong_number: "âš ï¸ YanlÄ±ÅŸ Numara",
        not_interested: "ğŸš« Ä°lgilenmiyor"
      };
      actions.push({
        id: log.id,
        type: "call",
        date: log.date,
        icon: "ğŸ“",
        text: `${contact?.name || "Kontakt"} arandÄ±`,
        detail: resultLabels[log.result] || log.result,
        company: company?.name || "",
        result: log.result
      });
    });

    // 2. Completed todos - each completed todo is an action
    (data.todos || []).filter(t => t.done).forEach(todo => {
      actions.push({
        id: `todo-${todo.id}`,
        type: "todo",
        date: todo.completedAt || todo.createdAt,
        icon: "âœ…",
        text: todo.text,
        detail: "To-Do tamamlandÄ±",
        company: todo.company || ""
      });
    });

    // Sort by date descending (newest first)
    actions.sort((a, b) => new Date(b.date) - new Date(a.date));

    // Group by date
    const byDate = {};
    actions.forEach(action => {
      const dateKey = new Date(action.date).toLocaleDateString("tr", { day: "numeric", month: "long", year: "numeric" });
      if (!byDate[dateKey]) byDate[dateKey] = [];
      byDate[dateKey].push(action);
    });

    return (
      <div>
        <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 16 }}>
          <div style={{ fontSize: 18, fontWeight: 800 }}>Aksiyonlar ({actions.length})</div>
        </div>

        {Object.entries(byDate).map(([date, items]) => (
          <div key={date} style={{ marginBottom: 20 }}>
            <div style={{ fontSize: 13, fontWeight: 700, color: colors.accent, marginBottom: 8, borderBottom: `1px solid ${colors.border}`, paddingBottom: 4 }}>
              ğŸ“… {date} ({items.length} aksiyon)
            </div>
            {items.map(action => (
              <div key={action.id} style={{ ...s.card, padding: "10px 14px", display: "flex", alignItems: "center", gap: 12, marginBottom: 6 }}>
                <span style={{ fontSize: 16 }}>{action.icon}</span>
                <div style={{ flex: 1 }}>
                  <div style={{ fontSize: 12, fontWeight: 600 }}>{action.text}</div>
                  {action.company && <div style={{ fontSize: 10, color: colors.textDim }}>{action.company}</div>}
                </div>
                <Badge
                  color={action.result === "meeting" ? colors.green : action.result === "introduced" ? colors.yellow : action.result === "unreached" ? colors.red : colors.textDim}
                  bg={action.result === "meeting" ? colors.greenDim : action.result === "introduced" ? colors.yellowDim : action.result === "unreached" ? colors.redDim : colors.surfaceHover}
                >
                  {action.detail}
                </Badge>
                <span style={{ fontSize: 10, color: colors.textDim }}>
                  {new Date(action.date).toLocaleTimeString("tr", { hour: "2-digit", minute: "2-digit" })}
                </span>
              </div>
            ))}
          </div>
        ))}

        {actions.length === 0 && (
          <div style={{ ...s.card, textAlign: "center", color: colors.textMuted, padding: 30 }}>
            HenÃ¼z aksiyon yok. Arama yaptÄ±kÃ§a ve to-do'larÄ± tamamladÄ±kÃ§a burada gÃ¶rÃ¼necek.
          </div>
        )}
      </div>
    );
  };

  // ============================================================
  // MODALS
  // ============================================================

  const renderModals = () => (
    <>
      {/* Import Preview Modal */}
      {importPreview && (
        <div style={s.modal} onClick={() => setImportPreview(null)}>
          <div style={{ ...s.modalContent, maxWidth: 900 }} onClick={e => e.stopPropagation()}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16 }}>
              <div style={{ fontWeight: 700, fontSize: 15 }}>
                Excel Ã–nizleme â€” {importType === "lusha" ? "Lusha Kontakt" : "AVM Analiz"} ({importPreview.rows.length} satÄ±r{importPreview.fileCount > 1 ? `, ${importPreview.fileCount} dosya` : ""})
              </div>
              <div style={{ display: "flex", gap: 8, alignItems: "center" }}>
                <button style={s.btn("primary")} onClick={() => importType === "lusha" ? processLushaImport(importPreview) : processAVMImport(importPreview)}>
                  <CheckIcon size={14}/> Ä°Ã§e Aktar ({importPreview.rows.length} satÄ±r)
                </button>
                <button style={s.btn()} onClick={() => setImportPreview(null)}>Ä°ptal</button>
                <button style={s.btn("danger")} onClick={() => setImportPreview(null)}><XIcon size={14}/></button>
              </div>
            </div>

            <div style={{ overflowX: "auto", marginBottom: 16, maxHeight: 500, overflowY: "auto" }}>
              <table style={{ ...s.table, minWidth: 1500 }}>
                <thead style={{ position: "sticky", top: 0, background: colors.surface }}>
                  <tr>{importPreview.headers.map(h => <th key={h} style={{ ...s.th, whiteSpace: "nowrap" }}>{h}</th>)}</tr>
                </thead>
                <tbody>
                  {importPreview.rows.slice(0, 50).map((row, i) => (
                    <tr key={i}>
                      {importPreview.headers.map(h => <td key={h} style={{ ...s.td, maxWidth: 200, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{row[h]}</td>)}
                    </tr>
                  ))}
                </tbody>
              </table>
              {importPreview.rows.length > 50 && <div style={{ fontSize: 11, color: colors.textMuted, marginTop: 8 }}>...ve {importPreview.rows.length - 50} satÄ±r daha</div>}
            </div>
          </div>
        </div>
      )}

      {/* Add Company Modal */}
      {showModal === "addCompany" && (
        <div style={s.modal} onClick={() => setShowModal(null)}>
          <div style={s.modalContent} onClick={e => e.stopPropagation()}>
            <div style={{ fontWeight: 700, fontSize: 15, marginBottom: 16 }}>Yeni Firma Ekle</div>
            <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
              <div>
                <label style={{ fontSize: 11, color: colors.textMuted }}>Firma AdÄ± *</label>
                <input style={s.input} value={modalData.name || ""} onChange={e => setModalData({ ...modalData, name: e.target.value })} />
              </div>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 }}>
                <div>
                  <label style={{ fontSize: 11, color: colors.textMuted }}>Cihaz Durumu</label>
                  <select style={s.select} value={modalData.deviceStatus} onChange={e => setModalData({ ...modalData, deviceStatus: e.target.value })}>
                    <option value="unknown">Bilinmiyor</option>
                    <option value="none">Cihaz Yok</option>
                    <option value="competitor">Cihaz Var</option>
                  </select>
                </div>
                <div>
                  <label style={{ fontSize: 11, color: colors.textMuted }}>Cihaz MarkasÄ±</label>
                  <select style={s.select} value={modalData.deviceBrand || ""} onChange={e => setModalData({ ...modalData, deviceBrand: e.target.value })}>
                    <option value="">SeÃ§iniz...</option>
                    {(data.competitors || []).map(comp => (
                      <option key={comp.id} value={comp.name}>{comp.name}</option>
                    ))}
                  </select>
                </div>
              </div>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 }}>
                <div>
                  <label style={{ fontSize: 11, color: colors.textMuted }}>LinkedIn URL</label>
                  <input style={s.input} value={modalData.linkedin || ""} onChange={e => setModalData({ ...modalData, linkedin: e.target.value })} />
                </div>
                <div>
                  <label style={{ fontSize: 11, color: colors.textMuted }}>Website</label>
                  <input style={s.input} value={modalData.website || ""} onChange={e => setModalData({ ...modalData, website: e.target.value })} />
                </div>
              </div>
              <div>
                <label style={{ fontSize: 11, color: colors.textMuted }}>Hedef Hafta</label>
                <input style={{ ...s.input, width: 80 }} type="number" value={modalData.targetWeek} onChange={e => setModalData({ ...modalData, targetWeek: parseInt(e.target.value) })} />
              </div>
              <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                <input type="checkbox" checked={modalData.isParent} onChange={e => setModalData({ ...modalData, isParent: e.target.checked })} />
                <label style={{ fontSize: 12 }}>Bu bir Ã§atÄ± firmadÄ±r</label>
              </div>
              {!modalData.isParent && (
                <div>
                  <label style={{ fontSize: 11, color: colors.textMuted }}>Ã‡atÄ± Firma</label>
                  <select style={s.select} value={modalData.parentId || ""} onChange={e => setModalData({ ...modalData, parentId: e.target.value })}>
                    <option value="">Yok</option>
                    {data.companies.filter(c => c.isParent).map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                  </select>
                </div>
              )}
              <div>
                <label style={{ fontSize: 11, color: colors.textMuted }}>Notlar</label>
                <textarea style={{ ...s.input, height: 50 }} value={modalData.notes || ""} onChange={e => setModalData({ ...modalData, notes: e.target.value })} />
              </div>
            </div>
            <div style={{ display: "flex", gap: 8, marginTop: 16 }}>
              <button style={s.btn("primary")} onClick={saveCompany}>Kaydet</button>
              <button style={s.btn()} onClick={() => setShowModal(null)}>Ä°ptal</button>
            </div>
          </div>
        </div>
      )}

      {/* Add Contact Modal */}
      {showModal === "addContact" && (
        <div style={s.modal} onClick={() => setShowModal(null)}>
          <div style={s.modalContent} onClick={e => e.stopPropagation()}>
            <div style={{ fontWeight: 700, fontSize: 15, marginBottom: 16 }}>Yeni Kontakt Ekle</div>
            <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
              <div>
                <label style={{ fontSize: 11, color: colors.textMuted }}>Ä°sim Soyisim *</label>
                <input style={s.input} value={modalData.name || ""} onChange={e => setModalData({ ...modalData, name: e.target.value })} />
              </div>
              <div>
                <label style={{ fontSize: 11, color: colors.textMuted }}>Ãœnvan</label>
                <input style={s.input} value={modalData.title || ""} onChange={e => setModalData({ ...modalData, title: e.target.value })} />
              </div>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 10 }}>
                <div>
                  <label style={{ fontSize: 11, color: colors.textMuted }}>Telefon</label>
                  <input style={s.input} value={modalData.phone || ""} onChange={e => setModalData({ ...modalData, phone: e.target.value })} />
                </div>
                <div>
                  <label style={{ fontSize: 11, color: colors.textMuted }}>Email</label>
                  <input style={s.input} value={modalData.email || ""} onChange={e => setModalData({ ...modalData, email: e.target.value })} />
                </div>
                <div>
                  <label style={{ fontSize: 11, color: colors.textMuted }}>LinkedIn URL</label>
                  <input style={s.input} value={modalData.linkedin || ""} onChange={e => setModalData({ ...modalData, linkedin: e.target.value })} />
                </div>
              </div>
            </div>
            <div style={{ display: "flex", gap: 8, marginTop: 16 }}>
              <button style={s.btn("primary")} onClick={saveContact}>Kaydet</button>
              <button style={s.btn()} onClick={() => setShowModal(null)}>Ä°ptal</button>
            </div>
          </div>
        </div>
      )}

      {/* Character Profile Side Panel */}
      {showModal === "charProfile" && callResult && (
        <>
          <div style={s.sidePanelBackdrop} onClick={() => { setShowModal(null); setCallResult(null); }} />
          <div style={s.sidePanel}>
            <div style={{ padding: "16px 20px", borderBottom: `1px solid ${colors.border}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
              <div>
                <div style={{ fontWeight: 700, fontSize: 15 }}>ğŸ‘¤ Karakter Profili</div>
                <div style={{ fontSize: 12, color: colors.textMuted }}>{callResult.contactName} â€” {callResult.companyName}</div>
              </div>
              <button style={s.btn("danger")} onClick={() => { setShowModal(null); setCallResult(null); }}><XIcon size={16}/></button>
            </div>
            <div style={s.sidePanelContent}>
            <div style={{ fontSize: 11, color: colors.textDim, marginBottom: 12 }}>Bu bilgiler sonraki aramalarda sana rehber olacak</div>
            <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
              {[
                { key: "communication", label: "Ä°letiÅŸim tarzÄ± nasÄ±ldÄ±?", options: ["Resmi", "Samimi", "KÄ±sa-net", "Ã‡ok konuÅŸkan", "SorulmadÄ±"] },
                { key: "decisionAuth", label: "Karar verme yetkisi?", options: ["Tek karar verici", "ÃœstÃ¼ne danÄ±ÅŸacak", "Komite kararÄ±", "Belirsiz", "SorulmadÄ±"] },
                { key: "decisionSpeed", label: "Karar verme hÄ±zÄ±?", options: ["HÄ±zlÄ±", "YavaÅŸ/dÃ¼ÅŸÃ¼nÃ¼r", "Erteleyici", "SorulmadÄ±"] },
                { key: "arguments", label: "Ne tÃ¼r argÃ¼manlara aÃ§Ä±k?", options: ["Maliyet", "Teknoloji", "Referans/kanÄ±t", "ROI", "Marka", "SorulmadÄ±"] },
                { key: "competitorOpinion", label: "Rakip hakkÄ±nda ne dÃ¼ÅŸÃ¼nÃ¼yor?", options: ["Memnun", "ÅikayetÃ§i", "NÃ¶tr", "Bilgisi yok", "SorulmadÄ±"] },
                { key: "priceSensitivity", label: "Fiyat hassasiyeti?", options: ["Ã‡ok hassas", "Makul", "DeÄŸer Ã¶nemli", "SorulmadÄ±"] },
                { key: "urgency", label: "Aciliyeti var mÄ±?", options: ["Acil", "PlanlÄ± bÃ¼tÃ§e", "Acele yok", "Bilgi topluyor", "SorulmadÄ±"] },
              ].map(field => (
                <div key={field.key}>
                  <label style={{ fontSize: 11, color: colors.textMuted }}>{field.label}</label>
                  <div style={{ display: "flex", gap: 4, flexWrap: "wrap" }}>
                    {field.options.map(opt => (
                      <button key={opt} style={s.btn(charProfile[field.key] === opt ? "primary" : "default")} onClick={() => setCharProfile({ ...charProfile, [field.key]: opt })}>
                        {opt}
                      </button>
                    ))}
                  </div>
                </div>
              ))}
              <div>
                <label style={{ fontSize: 11, color: colors.textMuted }}>KiÅŸisel gÃ¶zlemler</label>
                <textarea style={{ ...s.input, height: 60 }} value={charProfile.personalNotes || ""} onChange={e => setCharProfile({ ...charProfile, personalNotes: e.target.value })} placeholder="futbol sever, sabah aramalarÄ± tercih ediyor, asistanÄ± Ã¼zerinden iletiyor..." />
              </div>
              <div>
                <label style={{ fontSize: 11, color: colors.yellow }}>âš ï¸ Sonraki aramada sor (hatÄ±rlatÄ±cÄ±)</label>
                <textarea style={{ ...s.input, height: 50, borderColor: colors.yellow }} value={charProfile.nextCallAsk || ""} onChange={e => setCharProfile({ ...charProfile, nextCallAsk: e.target.value })} placeholder="neden istemediklerini sor, fiyat hassasiyetini Ã¶ÄŸren, karar verici kim..." />
              </div>
            </div>
            <div style={{ display: "flex", gap: 8, marginTop: 16 }}>
              <button style={s.btn("primary")} onClick={saveCharProfile}>Kaydet</button>
              <button style={s.btn()} onClick={() => { setShowModal(null); setCallResult(null); }}>Atla</button>
            </div>
            </div>
          </div>
        </>
      )}

      {/* Contact Profile Modal */}
      {showModal === "contactProfile" && selectedContact && (() => {
        // Use fresh contact data from state (not stale selectedContact)
        const ct = data.contacts.find(c => c.id === selectedContact.id) || selectedContact;
        const company = data.companies.find(c => c.id === ct.companyId);
        const profile = getProfile(ct.id);
        const contactLogs = data.callLogs?.filter(l => l.contactId === ct.id) || [];

        return (
          <div style={s.modal} onClick={() => { setShowModal(null); setSelectedContact(null); }}>
            <div style={{ ...s.modalContent, maxWidth: 700, width: "95vw", maxHeight: "90vh", overflowY: "auto" }} onClick={e => e.stopPropagation()}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16 }}>
                <div>
                  <div style={{ fontWeight: 700, fontSize: 18 }}>{ct.name}</div>
                  <div style={{ fontSize: 12, color: colors.textMuted }}>{ct.title} â€” {company?.name}</div>
                </div>
                <button style={s.btn("danger")} onClick={() => { setShowModal(null); setSelectedContact(null); }}><XIcon size={16}/></button>
              </div>

              {/* Contact Info */}
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12, marginBottom: 16 }}>
                <div>
                  <label style={{ fontSize: 10, color: colors.textDim }}>Telefon 1</label>
                  <input style={s.input} value={ct.phone || ""} onChange={(e) => updateContactField(ct.id, "phone", e.target.value)} placeholder="â€”" />
                </div>
                <div>
                  <label style={{ fontSize: 10, color: colors.textDim }}>Telefon 2</label>
                  <input style={s.input} value={ct.phone2 || ""} onChange={(e) => updateContactField(ct.id, "phone2", e.target.value)} placeholder="â€”" />
                </div>
                <div>
                  <label style={{ fontSize: 10, color: colors.textDim }}>Email</label>
                  <input style={s.input} value={ct.email || ""} onChange={(e) => updateContactField(ct.id, "email", e.target.value)} placeholder="â€”" />
                </div>
                <div>
                  <label style={{ fontSize: 10, color: colors.textDim }}>LinkedIn</label>
                  <input style={s.input} value={ct.linkedin || ""} onChange={(e) => updateContactField(ct.id, "linkedin", e.target.value)} placeholder="â€”" />
                </div>
                <div>
                  <label style={{ fontSize: 10, color: colors.textDim }}>Ã–ncelik</label>
                  <select style={s.select} value={ct.priority || ""} onChange={(e) => updateContactField(ct.id, "priority", e.target.value ? parseInt(e.target.value) : null)}>
                    <option value="">â€”</option>
                    <option value={1}>1 - En YÃ¼ksek</option>
                    <option value={2}>2</option>
                    <option value={3}>3</option>
                    <option value={4}>4</option>
                    <option value={5}>5 - En DÃ¼ÅŸÃ¼k</option>
                  </select>
                </div>
                <div>
                  <label style={{ fontSize: 10, color: colors.textDim }}>Takip SÄ±klÄ±ÄŸÄ± (gÃ¼n)</label>
                  <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                    <input
                      type="text"
                      inputMode="numeric"
                      pattern="[0-9]*"
                      style={{ ...s.input, width: 60 }}
                      value={ct.followUpDays || ""}
                      onChange={(e) => {
                        const val = e.target.value.replace(/[^0-9]/g, "");
                        updateContactField(ct.id, "followUpDays", val ? parseInt(val) : null);
                      }}
                      placeholder="30"
                    />
                    {ct.followUpDays && (() => {
                      const d = new Date();
                      d.setDate(d.getDate() + ct.followUpDays);
                      const week = getWeekNumber(d);
                      return (
                        <span style={{ fontSize: 12, fontWeight: 600, color: colors.accent, background: colors.accentDim, padding: "4px 8px", borderRadius: 4 }}>
                          â†’ H{week}
                        </span>
                      );
                    })()}
                  </div>
                </div>
              </div>

              {/* Quick Call Buttons */}
              {(ct.phone || ct.phone2) && (
                <div style={{ display: "flex", gap: 8, marginBottom: 16 }}>
                  {ct.phone && (
                    <button
                      style={{ ...s.btn("success"), flex: 1, padding: "10px" }}
                      onClick={() => { setSelectedContact(null); openCallLog(company, ct); }}
                    >
                      ğŸ“ Tel 1: {ct.phone}
                    </button>
                  )}
                  {ct.phone2 && (
                    <button
                      style={{ ...s.btn("success"), flex: 1, padding: "10px" }}
                      onClick={() => { setSelectedContact(null); openCallLog(company, { ...ct, phone: ct.phone2 }); }}
                    >
                      ğŸ“ Tel 2: {ct.phone2}
                    </button>
                  )}
                </div>
              )}

              {/* Next Call Reminder */}
              {profile?.nextCallAsk && (
                <div style={{ ...s.card, marginBottom: 16, borderColor: colors.yellow, borderWidth: 2 }}>
                  <div style={{ fontSize: 12, fontWeight: 700, color: colors.yellow, marginBottom: 6 }}>âš ï¸ SONRAKÄ° ARAMADA SOR</div>
                  <div style={{ fontSize: 12, color: colors.text }}>{profile.nextCallAsk}</div>
                </div>
              )}

              {/* Character Profile */}
              <div style={{ ...s.card, marginBottom: 16 }}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
                  <div style={{ fontSize: 12, fontWeight: 700, color: colors.textMuted }}>KARAKTERÄ°STÄ°K PROFÄ°L</div>
                  <button
                    style={{ ...s.btn("primary"), fontSize: 11, padding: "4px 10px" }}
                    onClick={() => {
                      // Pre-fill with existing profile or empty
                      const existingProfile = profile || {};
                      setCharProfile({
                        communication: existingProfile.communication || "",
                        decisionAuth: existingProfile.decisionAuth || "",
                        decisionSpeed: existingProfile.decisionSpeed || "",
                        arguments: existingProfile.arguments || "",
                        competitorOpinion: existingProfile.competitorOpinion || "",
                        priceSensitivity: existingProfile.priceSensitivity || "",
                        urgency: existingProfile.urgency || "",
                        personalNotes: existingProfile.personalNotes || "",
                        nextCallAsk: existingProfile.nextCallAsk || ""
                      });
                      setCallResult({
                        contactId: ct.id,
                        contactName: ct.name,
                        companyId: ct.companyId,
                        companyName: company?.name
                      });
                      setShowModal("charProfile");
                      setSelectedContact(null);
                    }}
                  >
                    âœï¸ DÃ¼zenle
                  </button>
                </div>
                {profile ? (
                  <div>
                    <div style={{ display: "flex", flexWrap: "wrap", gap: 6, marginBottom: 10 }}>
                      {profile.communication && profile.communication !== "SorulmadÄ±" && (
                        <Badge color={colors.accent} bg={colors.accentDim}>ğŸ’¬ {profile.communication}</Badge>
                      )}
                      {profile.decisionAuth && profile.decisionAuth !== "SorulmadÄ±" && (
                        <Badge color={colors.purple} bg="#2d1a4e">ğŸ‘¤ {profile.decisionAuth}</Badge>
                      )}
                      {profile.decisionSpeed && profile.decisionSpeed !== "SorulmadÄ±" && (
                        <Badge color={colors.green} bg={colors.greenDim}>âš¡ {profile.decisionSpeed}</Badge>
                      )}
                      {profile.arguments && profile.arguments !== "SorulmadÄ±" && (
                        <Badge color={colors.orange} bg="#3d1e08">ğŸ’¡ {profile.arguments}</Badge>
                      )}
                      {profile.competitorOpinion && profile.competitorOpinion !== "SorulmadÄ±" && (
                        <Badge color={colors.red} bg={colors.redDim}>ğŸ¢ Rakip: {profile.competitorOpinion}</Badge>
                      )}
                      {profile.priceSensitivity && profile.priceSensitivity !== "SorulmadÄ±" && (
                        <Badge color={colors.green} bg={colors.greenDim}>ğŸ’° {profile.priceSensitivity}</Badge>
                      )}
                      {profile.urgency && profile.urgency !== "SorulmadÄ±" && (
                        <Badge color={colors.red} bg={colors.redDim}>ğŸ”¥ {profile.urgency}</Badge>
                      )}
                    </div>
                    {profile.personalNotes && (
                      <div style={{ padding: 10, background: colors.surfaceHover, borderRadius: 6, fontSize: 12 }}>
                        <div style={{ color: colors.textDim, marginBottom: 4 }}>ğŸ“ Notlar:</div>
                        <div style={{ color: colors.text }}>{profile.personalNotes}</div>
                      </div>
                    )}
                    {profile.updatedAt && (
                      <div style={{ fontSize: 10, color: colors.textDim, marginTop: 8 }}>Son gÃ¼ncelleme: {new Date(profile.updatedAt).toLocaleDateString("tr")}</div>
                    )}
                  </div>
                ) : (
                  <div style={{ color: colors.textDim, fontSize: 12 }}>HenÃ¼z profil bilgisi yok. DÃ¼zenle butonuna tÄ±klayarak baÅŸla.</div>
                )}
              </div>

              {/* Call History */}
              <div style={{ ...s.card }}>
                <div style={{ fontSize: 12, fontWeight: 700, color: colors.textMuted, marginBottom: 10 }}>ARAMA GEÃ‡MÄ°ÅÄ° ({contactLogs.length})</div>
                {contactLogs.length === 0 ? (
                  <div style={{ color: colors.textDim, fontSize: 12 }}>HenÃ¼z arama kaydÄ± yok.</div>
                ) : (
                  contactLogs.map(log => (
                    <div key={log.id} style={{ fontSize: 12, padding: "8px 0", borderBottom: `1px solid ${colors.border}` }}>
                      <div style={{ display: "flex", gap: 8, alignItems: "center", marginBottom: 4 }}>
                        <span style={{ color: colors.textDim }}>{new Date(log.date).toLocaleDateString("tr")}</span>
                        <Badge color={log.result === "meeting" ? colors.green : log.result === "introduced" ? colors.yellow : colors.red} bg={log.result === "meeting" ? colors.greenDim : log.result === "introduced" ? colors.yellowDim : colors.redDim}>
                          {log.result === "meeting" ? "ToplantÄ±" : log.result === "introduced" ? "UlaÅŸÄ±ldÄ±" : log.result === "unreached" ? "UlaÅŸÄ±lamadÄ±" : log.result === "not_interested" ? "Ä°lgilenmiyor" : log.result}
                        </Badge>
                      </div>
                      {log.notes && <div style={{ color: colors.textMuted }}>{log.notes}</div>}
                    </div>
                  ))
                )}
              </div>

              {/* Contact To-Dos */}
              <div style={{ ...s.card, marginTop: 16 }}>
                <div style={{ fontSize: 12, fontWeight: 700, color: colors.textMuted, marginBottom: 10 }}>KÄ°ÅÄ°YE Ã–ZEL TO-DO</div>


                {/* Custom To-Do Input */}
                <div style={{ display: "flex", gap: 8 }}>
                  <input
                    style={{ ...s.input, flex: 1 }}
                    placeholder="Ã–zel to-do ekle..."
                    onKeyDown={(e) => {
                      if (e.key === "Enter" && e.target.value.trim()) {
                        updateData(prev => ({
                          ...prev,
                          todos: [...(prev.todos || []), {
                            id: uid(),
                            text: `${e.target.value} â€” ${ct.name} (${company?.name})`,
                            type: "manual",
                            category: "takip",
                            priority: 3,
                            done: false,
                            contactId: ct.id,
                            companyId: ct.companyId,
                            createdAt: new Date().toISOString()
                          }]
                        }));
                        e.target.value = "";
                      }
                    }}
                  />
                  <button
                    style={s.btn("primary")}
                    onClick={(e) => {
                      const input = e.target.previousSibling;
                      if (input.value.trim()) {
                        updateData(prev => ({
                          ...prev,
                          todos: [...(prev.todos || []), {
                            id: uid(),
                            text: `${input.value} â€” ${ct.name} (${company?.name})`,
                            type: "manual",
                            category: "takip",
                            priority: 3,
                            done: false,
                            contactId: ct.id,
                            companyId: ct.companyId,
                            createdAt: new Date().toISOString()
                          }]
                        }));
                        input.value = "";
                      }
                    }}
                  >
                    <PlusIcon size={14}/>
                  </button>
                </div>

                {/* All Contact To-Dos */}
                {(() => {
                  const allContactTodos = (data.todos || []).filter(t => t.contactId === ct.id);
                  const profileTodos = allContactTodos.filter(t => t.profileKey && !t.done);
                  const actionTodos = allContactTodos.filter(t => (t.todoKey || !t.profileKey) && !t.done);
                  const doneTodos = allContactTodos.filter(t => t.done);

                  return (
                    <div style={{ marginTop: 10 }}>
                      {/* SorulmasÄ± Gerekenler */}
                      {profileTodos.length > 0 && (
                        <>
                          <div style={{ fontSize: 11, color: colors.yellow, marginBottom: 6 }}>â“ SorulmasÄ± Gerekenler:</div>
                          {profileTodos.map(todo => (
                            <div key={todo.id} style={{ display: "flex", alignItems: "center", gap: 8, fontSize: 12, padding: "6px 8px", background: colors.yellowDim, borderRadius: 4, marginBottom: 4 }}>
                              <input
                                type="checkbox"
                                checked={false}
                                onChange={() => updateData(prev => ({
                                  ...prev,
                                  todos: prev.todos.map(t => t.id === todo.id ? { ...t, done: true } : t)
                                }))}
                              />
                              <span style={{ flex: 1, color: colors.text }}>{todo.text.split(" â€” ")[0]}</span>
                              <select
                                style={{ ...s.select, fontSize: 10, padding: "2px 4px", width: 55, background: colors.accentDim, color: colors.accent }}
                                value={todo.targetWeek || ""}
                                onChange={(e) => {
                                  const week = e.target.value ? parseInt(e.target.value) : null;
                                  updateData(prev => ({
                                    ...prev,
                                    todos: prev.todos.map(t => t.id === todo.id ? { ...t, targetWeek: week, targetYear: week ? currentYear : null } : t)
                                  }));
                                }}
                              >
                                <option value="">â€”</option>
                                {[...Array(8)].map((_, i) => <option key={i} value={currentWeek + i}>H{currentWeek + i}</option>)}
                              </select>
                              <button style={{ ...s.btn("danger"), padding: "2px 6px" }} onClick={() => updateData(prev => ({ ...prev, todos: prev.todos.filter(t => t.id !== todo.id) }))}><TrashIcon size={10}/></button>
                            </div>
                          ))}
                        </>
                      )}

                      {/* Aktif To-Do'lar */}
                      {actionTodos.length > 0 && (
                        <>
                          <div style={{ fontSize: 11, color: colors.textDim, marginBottom: 6, marginTop: profileTodos.length > 0 ? 10 : 0 }}>ğŸ“‹ YapÄ±lacaklar:</div>
                          {actionTodos.map(todo => (
                            <div key={todo.id} style={{ display: "flex", alignItems: "center", gap: 8, fontSize: 12, padding: "4px 0" }}>
                              <input
                                type="checkbox"
                                checked={false}
                                onChange={() => updateData(prev => ({
                                  ...prev,
                                  todos: prev.todos.map(t => t.id === todo.id ? { ...t, done: true } : t)
                                }))}
                              />
                              <span style={{ flex: 1, color: colors.text }}>{todo.text.split(" â€” ")[0]}</span>
                              <select
                                style={{ ...s.select, fontSize: 10, padding: "2px 4px", width: 55, background: todo.targetWeek ? colors.accentDim : "transparent", color: todo.targetWeek ? colors.accent : colors.textDim }}
                                value={todo.targetWeek || ""}
                                onChange={(e) => {
                                  const week = e.target.value ? parseInt(e.target.value) : null;
                                  updateData(prev => ({
                                    ...prev,
                                    todos: prev.todos.map(t => t.id === todo.id ? { ...t, targetWeek: week, targetYear: week ? currentYear : null } : t)
                                  }));
                                }}
                              >
                                <option value="">â€”</option>
                                {[...Array(8)].map((_, i) => <option key={i} value={currentWeek + i}>H{currentWeek + i}</option>)}
                              </select>
                              <button style={{ ...s.btn("danger"), padding: "2px 6px" }} onClick={() => updateData(prev => ({ ...prev, todos: prev.todos.filter(t => t.id !== todo.id) }))}><TrashIcon size={10}/></button>
                            </div>
                          ))}
                        </>
                      )}

                      {/* Tamamlananlar */}
                      {doneTodos.length > 0 && (
                        <>
                          <div style={{ fontSize: 11, color: colors.green, marginBottom: 6, marginTop: 10 }}>âœ… Tamamlanan:</div>
                          {doneTodos.map(todo => (
                            <div key={todo.id} style={{ display: "flex", alignItems: "center", gap: 8, fontSize: 12, padding: "4px 0", opacity: 0.6 }}>
                              <input
                                type="checkbox"
                                checked={true}
                                onChange={() => updateData(prev => ({
                                  ...prev,
                                  todos: prev.todos.map(t => t.id === todo.id ? { ...t, done: false } : t)
                                }))}
                              />
                              <span style={{ flex: 1, textDecoration: "line-through", color: colors.textDim }}>{todo.text.split(" â€” ")[0]}</span>
                              <button style={{ ...s.btn("danger"), padding: "2px 6px" }} onClick={() => updateData(prev => ({ ...prev, todos: prev.todos.filter(t => t.id !== todo.id) }))}><TrashIcon size={10}/></button>
                            </div>
                          ))}
                        </>
                      )}

                      {/* HÄ±zlÄ± Ekle ButonlarÄ± */}
                      <div style={{ fontSize: 11, color: colors.accent, marginBottom: 6, marginTop: 12 }}>â• HÄ±zlÄ± Ekle:</div>
                      <div style={{ display: "flex", flexWrap: "wrap", gap: 6 }}>
                        {[
                          { key: "whatsapp", label: "ğŸ“± WP kiÅŸi kartÄ±", today: true },
                          { key: "linkedin", label: "ğŸ”— LinkedIn baÄŸlan", today: true },
                          { key: "email", label: "âœ‰ï¸ Mail at", today: true },
                          { key: "info", label: "ğŸ“„ Bilgi gÃ¶nder", today: true },
                          { key: "callback", label: "ğŸ“ Geri ara", today: false },
                        ].map(item => {
                          const today = new Date();
                          let targetDate, targetWeek, targetYear;

                          if (item.today) {
                            targetDate = today.toISOString().split("T")[0];
                            targetWeek = getWeekNumber(today);
                            targetYear = today.getFullYear();
                          } else if (ct.followUpDays) {
                            const d = new Date();
                            d.setDate(d.getDate() + ct.followUpDays);
                            targetDate = d.toISOString().split("T")[0];
                            targetWeek = getWeekNumber(d);
                            targetYear = d.getFullYear();
                          } else {
                            targetDate = today.toISOString().split("T")[0];
                            targetWeek = getWeekNumber(today);
                            targetYear = today.getFullYear();
                          }

                          return (
                            <button
                              key={item.key}
                              style={{ ...s.btn(), fontSize: 11, padding: "4px 8px" }}
                              onClick={() => {
                                updateData(prev => ({
                                  ...prev,
                                  todos: [...(prev.todos || []), {
                                    id: uid(),
                                    text: `${item.label} â€” ${ct.name} (${company?.name})`,
                                    todoKey: item.key,
                                    type: "manual",
                                    category: "takip",
                                    priority: 2,
                                    done: false,
                                    contactId: ct.id,
                                    companyId: ct.companyId,
                                    targetDate,
                                    targetWeek,
                                    targetYear,
                                    createdAt: new Date().toISOString()
                                  }]
                                }));
                              }}
                            >
                              + {item.label}
                            </button>
                          );
                        })}
                      </div>
                    </div>
                  );
                })()}
              </div>

              {/* Contact Notes */}
              <div style={{ marginTop: 16 }}>
                <label style={{ fontSize: 10, color: colors.textDim }}>KiÅŸi NotlarÄ±</label>
                <textarea
                  style={{ ...s.input, height: 80, resize: "vertical" }}
                  value={ct.notes || ""}
                  onChange={(e) => updateContactField(ct.id, "notes", e.target.value)}
                  placeholder="Bu kiÅŸi hakkÄ±nda notlar..."
                />
              </div>
            </div>
          </div>
        );
      })()}
    </>
  );

  // ============================================================
  // COMPANY DETAIL PANEL (SOL)
  // ============================================================

  const renderCompanyPanel = () => {
    if (!expandedFirm) return null;
    const company = data.companies.find(c => c.id === expandedFirm);
    if (!company) return null;
    const contacts = getContacts(company.id);
    const parent = getParentCompany(company.id);
    const logs = getCallLogs(company.id);

    return (
      <div style={{
        background: colors.surface,
        borderLeft: showCallPanel ? "none" : `1px solid ${colors.border}`,
        borderRight: showCallPanel ? `1px solid ${colors.border}` : "none",
        display: "flex",
        flexDirection: "column",
        overflow: "hidden"
      }}>
        <div style={{ padding: "12px 16px", borderBottom: `1px solid ${colors.border}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
          <div>
            <div style={{ fontWeight: 700, fontSize: 16 }}>{company.name}</div>
            {parent && <div style={{ fontSize: 11, color: colors.textMuted }}>â†³ {parent.name}</div>}
          </div>
          <button style={s.btn("danger")} onClick={() => setExpandedFirm(null)}><XIcon size={16}/></button>
        </div>
        <div style={{ flex: 1, padding: 16, overflowY: "auto" }}>
          {/* Quick Links */}
          <div style={{ display: "flex", gap: 8, marginBottom: 12, flexWrap: "wrap" }}>
            {company.linkedin && <a href={company.linkedin} target="_blank" rel="noopener noreferrer" style={{ ...s.btn(), textDecoration: "none" }}><LinkedinIcon size={14}/> LinkedIn</a>}
            {company.website && <a href={company.website.startsWith("http") ? company.website : `https://${company.website}`} target="_blank" rel="noopener noreferrer" style={{ ...s.btn(), textDecoration: "none" }}><GlobeIcon size={14}/> Website</a>}
            <button style={s.btn()} onClick={() => openAddContact(company.id)}><PlusIcon size={14}/> Kontakt Ekle</button>
          </div>

          {/* Category & Status */}
          <div style={{ display: "flex", gap: 8, marginBottom: 12, alignItems: "center", flexWrap: "wrap" }}>
            <select style={s.select} value={company.trackingType || ""} onChange={(e) => {
              const val = e.target.value;
              updateCompanyField(company.id, "trackingType", val || null);
              if (val === "target" && !company.targetWeek) {
                updateCompanyField(company.id, "targetWeek", currentWeek);
                updateCompanyField(company.id, "targetYear", currentYear);
              }
            }}>
              <option value="">Kategori SeÃ§</option>
              <option value="target">Hedef Firma</option>
              <option value="followup">DÃ¼zenli Takip</option>
            </select>
            {company.trackingType === "target" && (
              <select style={{ ...s.select, minWidth: 70 }} value={company.targetWeek || currentWeek} onChange={(e) => {
                updateCompanyField(company.id, "targetWeek", parseInt(e.target.value));
                updateCompanyField(company.id, "targetYear", currentYear);
              }}>
                {[...Array(6)].map((_, i) => (
                  <option key={i} value={currentWeek + i}>H{currentWeek + i}</option>
                ))}
              </select>
            )}
            <select style={s.select} value={company.status || ""} onChange={(e) => updateCompanyField(company.id, "status", e.target.value || null)}>
              <option value="">{contacts.some(c => c.phone) ? "Kontakt HazÄ±r (Oto)" : "HazÄ±r Kontakt Yok (Oto)"}</option>
              <option value="unreached">UlaÅŸÄ±lamadÄ±</option>
              <option value="wrong_person">UlaÅŸÄ±ldÄ± - YanlÄ±ÅŸ KiÅŸi</option>
              <option value="meeting">ToplantÄ± AlÄ±ndÄ±</option>
              <option value="not_interested">Ä°lgilenmiyor</option>
            </select>
          </div>

          {/* Device Info */}
          <div style={{ ...s.card, padding: 12, marginBottom: 12, display: "flex", gap: 12, alignItems: "flex-end" }}>
            <div style={{ flex: 1 }}>
              <div style={{ fontSize: 10, color: colors.textMuted, marginBottom: 4 }}>Cihaz Durumu</div>
              <select style={{ ...s.select, width: "100%" }} value={company.deviceStatus || "unknown"} onChange={(e) => updateCompanyField(company.id, "deviceStatus", e.target.value)}>
                <option value="unknown">Bilinmiyor</option>
                <option value="none">Cihaz Yok</option>
                <option value="competitor">Rakip Cihaz Var</option>
                <option value="ours">Bizde</option>
              </select>
            </div>
            {company.deviceStatus === "competitor" && (
              <div style={{ flex: 1 }}>
                <div style={{ fontSize: 10, color: colors.textMuted, marginBottom: 4 }}>Cihaz MarkasÄ±</div>
                <select style={{ ...s.select, width: "100%" }} value={company.deviceBrand || ""} onChange={(e) => updateCompanyField(company.id, "deviceBrand", e.target.value)}>
                  <option value="">SeÃ§iniz...</option>
                  {(data.competitors || []).map(comp => (
                    <option key={comp.id} value={comp.name}>{comp.name}</option>
                  ))}
                  {company.deviceBrand && !(data.competitors || []).some(c => c.name === company.deviceBrand) && (
                    <option value={company.deviceBrand}>{company.deviceBrand} (eski)</option>
                  )}
                </select>
              </div>
            )}
            {company.deviceStatus === "competitor" && company.deviceBrand && (
              <div style={{ flex: 1 }}>
                <div style={{ fontSize: 10, color: colors.textMuted, marginBottom: 4 }}>Kontrat BitiÅŸ</div>
                <input type="date" style={s.input} value={company.contractEndDate || ""} onChange={(e) => updateCompanyField(company.id, "contractEndDate", e.target.value)} />
              </div>
            )}
          </div>

          {/* Contacts */}
          <div style={{ fontSize: 11, fontWeight: 700, color: colors.textMuted, marginBottom: 8 }}>KONTAKTLAR ({contacts.length})</div>
          {contacts.length === 0 && <div style={{ color: colors.textDim, fontSize: 12 }}>HenÃ¼z kontakt yok</div>}
          {contacts.map(ct => {
            const profile = getProfile(ct.id);
            return (
              <div key={ct.id} style={{ ...s.card, padding: "8px 12px", marginBottom: 4, display: "grid", gridTemplateColumns: "40px 1.5fr 2.2fr minmax(140px, 1fr) 1.5fr 50px 40px", alignItems: "center", gap: 8 }}>
                {/* 1. Ã–ncelik */}
                <select style={{ ...s.select, fontSize: 10, padding: "2px 4px" }} value={ct.priority || ""} onChange={(e) => updateContactField(ct.id, "priority", e.target.value ? parseInt(e.target.value) : null)}>
                  <option value="">â€”</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                </select>
                {/* 2. Ä°sim (tÄ±klanabilir - profil aÃ§ar) */}
                <span
                  style={{ fontWeight: 600, fontSize: 13, cursor: "pointer", color: colors.accent, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}
                  onClick={() => { setSelectedContact(ct); setShowModal("contactProfile"); }}
                  title="Profili aÃ§"
                >
                  {ct.name}
                  {ct.reached && <Badge color={colors.green} bg={colors.greenDim} style={{ marginLeft: 4 }}>âœ“</Badge>}
                </span>
                {/* 3. Ãœnvan */}
                <span style={{ fontSize: 11, color: colors.textMuted, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }} title={ct.title || ""}>
                  {ct.title || "â€”"}
                </span>
                {/* 4. Telefon NumaralarÄ± - Alt Alta */}
                <div style={{ display: "flex", flexDirection: "column", gap: 2 }}>
                  {ct.phone ? (
                    <button
                      style={{ ...s.btn("success"), fontSize: 10, padding: "3px 6px", width: "100%" }}
                      onClick={() => {
                        setCallResult({ companyId: company.id, contactId: ct.id, contactName: ct.name, companyName: company.name, phone: ct.phone, result: "", notes: "", date: new Date().toISOString() });
                        setShowCallPanel(true);
                      }}
                    >
                      ğŸ“ {ct.phone}
                    </button>
                  ) : <span style={{ fontSize: 10, color: colors.textDim }}>â€”</span>}
                  {ct.phone2 && (
                    <button
                      style={{ ...s.btn("success"), fontSize: 10, padding: "3px 6px", width: "100%" }}
                      onClick={() => {
                        setCallResult({ companyId: company.id, contactId: ct.id, contactName: ct.name, companyName: company.name, phone: ct.phone2, result: "", notes: "", date: new Date().toISOString() });
                        setShowCallPanel(true);
                      }}
                    >
                      ğŸ“ {ct.phone2}
                    </button>
                  )}
                </div>
                {/* 5. Email */}
                <span style={{ fontSize: 11, color: ct.email ? colors.yellow : colors.textDim, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }} title={ct.email || "Email yok"}>
                  {ct.email ? `âœ‰ï¸ ${ct.email}` : "â€”"}
                </span>
                {/* 6. LinkedIn */}
                {ct.linkedin ? (
                  <a href={ct.linkedin.startsWith("http") ? ct.linkedin : `https://${ct.linkedin}`} target="_blank" rel="noopener noreferrer" style={{ color: colors.accent, fontSize: 11, textAlign: "center" }} title={ct.linkedin}>
                    ğŸ”— in
                  </a>
                ) : (
                  <span style={{ fontSize: 11, color: colors.textDim, textAlign: "center" }}>â€”</span>
                )}
                {/* 7. Sil */}
                <button
                  style={{ ...s.btn("danger"), padding: "4px 8px", fontSize: 10 }}
                  onClick={() => { if (confirm(`"${ct.name}" kontaÄŸÄ±nÄ± silmek istediÄŸinize emin misiniz?`)) deleteContact(ct.id); }}
                  title="KontaÄŸÄ± sil"
                >
                  ğŸ—‘ï¸
                </button>
              </div>
            );
          })}

          {/* Call History */}
          {logs.length > 0 && (
            <div style={{ marginTop: 16 }}>
              <div style={{ fontSize: 11, fontWeight: 700, color: colors.textMuted, marginBottom: 8 }}>ARAMA GEÃ‡MÄ°ÅÄ°</div>
              {logs.slice(0, 5).map(log => (
                <div key={log.id} style={{ fontSize: 11, padding: "4px 0", borderBottom: `1px solid ${colors.border}`, display: "flex", gap: 8 }}>
                  <span style={{ color: colors.textDim }}>{new Date(log.date).toLocaleDateString("tr")}</span>
                  <Badge color={log.result === "meeting" ? colors.green : log.result === "introduced" ? colors.yellow : colors.red} bg={log.result === "meeting" ? colors.greenDim : log.result === "introduced" ? colors.yellowDim : colors.redDim}>
                    {log.result === "meeting" ? "ToplantÄ±" : log.result === "introduced" ? "UlaÅŸÄ±ldÄ±" : log.result === "unreached" ? "UlaÅŸÄ±lamadÄ±" : log.result}
                  </Badge>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    );
  };

  // ============================================================
  // CALL PANEL (SAÄ)
  // ============================================================

  const renderCallPanel = () => {
    if (!showCallPanel || !callResult) return null;

    return (
      <div style={{
        background: colors.surface,
        borderLeft: `1px solid ${colors.border}`,
        display: "flex",
        flexDirection: "column",
        overflow: "hidden"
      }}>
        <div style={{ padding: "12px 16px", borderBottom: `1px solid ${colors.border}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
          <div>
            <div style={{ fontWeight: 700, fontSize: 14 }}>ğŸ“ Arama Notu</div>
            <div style={{ fontSize: 11, color: colors.textMuted }}>{callResult.contactName} â€” {callResult.phone}</div>
          </div>
          <button style={s.btn("danger")} onClick={() => { setShowCallPanel(false); setCallResult(null); }}><XIcon size={16}/></button>
        </div>
        <div style={{ flex: 1, padding: 16, overflowY: "auto" }}>
          <div style={{ marginBottom: 12 }}>
            <label style={{ fontSize: 11, color: colors.textMuted }}>SonuÃ§</label>
            <div style={{ display: "flex", gap: 6, flexWrap: "wrap", marginTop: 4 }}>
              {[
                { value: "meeting", label: "âœ… ToplantÄ±", color: colors.green },
                { value: "introduced", label: "ğŸ¤ UlaÅŸÄ±ldÄ±", color: colors.yellow },
                { value: "unreached", label: "âŒ UlaÅŸÄ±lamadÄ±", color: colors.red },
                { value: "wrong_number", label: "âš ï¸ YanlÄ±ÅŸ No", color: colors.orange },
              ].map(opt => (
                <button
                  key={opt.value}
                  style={{ ...s.btn(callResult.result === opt.value ? "primary" : "default"), fontSize: 11 }}
                  onClick={() => setCallResult({ ...callResult, result: opt.value })}
                >
                  {opt.label}
                </button>
              ))}
            </div>
          </div>
          <div style={{ marginBottom: 12 }}>
            <label style={{ fontSize: 11, color: colors.textMuted }}>Not</label>
            <textarea style={{ ...s.input, height: 80, marginTop: 4 }} value={callResult.notes || ""} onChange={e => setCallResult({ ...callResult, notes: e.target.value })} placeholder="GÃ¶rÃ¼ÅŸme notlarÄ±..." />
          </div>
          <button style={{ ...s.btn("primary"), width: "100%" }} onClick={saveCallLog} disabled={!callResult.result}>Kaydet</button>
        </div>
      </div>
    );
  };

  // ============================================================
  // MAIN RENDER
  // ============================================================

  return (
    <div style={s.app}>
      {/* Header */}
      <div style={s.header}>
        <div style={s.logo}>REMVISION SALES</div>
        <div style={s.tabs}>
          {[
            { id: "weekly", label: `ğŸ“… Hafta ${selectedWeek}` },
            { id: "dashboard", label: "ğŸ“Š Dashboard" },
            { id: "companies", label: "ğŸ¢ Firmalar" },
            { id: "competitors", label: "âš”ï¸ Rakipler" },
            { id: "todos", label: "âœ… To-Do" },
            { id: "actions", label: "ğŸ“‹ Aksiyonlar" },
          ].map(t => (
            <button key={t.id} style={s.tab(activeTab === t.id)} onClick={() => { setActiveTab(t.id); if (t.id !== "weekly") setExpandedFirm(null); }}>{t.label}</button>
          ))}
        </div>
        <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
          <button style={s.btn("primary")} onClick={openAddCompany}><PlusIcon size={14}/> Firma Ekle</button>
          <button style={s.btn()} onClick={() => { setImportType("lusha"); fileInputRef.current?.click(); }}><UploadIcon size={14}/> Lusha</button>
          <button style={s.btn()} onClick={() => { setImportType("avm"); fileInputAvmRef.current?.click(); }}><UploadIcon size={14}/> AVM</button>
          <input ref={fileInputRef} type="file" accept=".csv,.tsv,.txt,.xlsx,.xls" style={{ display: "none" }} multiple onChange={(e) => { setImportType("lusha"); handleFileUpload(e); }} />
          <input ref={fileInputAvmRef} type="file" accept=".csv,.tsv,.txt,.xlsx,.xls" style={{ display: "none" }} onChange={(e) => { setImportType("avm"); handleFileUpload(e); }} />
          <div style={{ width: 1, height: 20, background: colors.border, margin: "0 4px" }}/>
          <button style={s.btn()} onClick={() => showSync("Manuel senkronizasyon âœ“")} title="Manuel Sync">
            <SyncIcon size={14}/>
          </button>
          <span style={{ fontSize: 10, color: colors.textDim }}>tugay.demircan@remvisionlab.com</span>
        </div>
      </div>

      {/* Main Grid Layout */}
      <div style={{
        display: "grid",
        gridTemplateColumns: expandedFirm
          ? (showCallPanel ? "2fr 1fr" : "1fr 2fr")
          : "1fr",
        flex: 1,
        overflow: "hidden",
        transition: "grid-template-columns 0.2s ease"
      }}>
        {/* Left Panel - Weekly View or Company Detail */}
        {!showCallPanel && (
          <div style={{ ...s.content, overflow: "auto" }}>
            {activeTab === "weekly" && renderWeeklyView()}
            {activeTab === "dashboard" && renderDashboard()}
            {activeTab === "companies" && renderAllCompanies()}
            {activeTab === "competitors" && renderCompetitors()}
            {activeTab === "todos" && renderTodos()}
            {activeTab === "actions" && renderActions()}
          </div>
        )}

        {/* Company Detail Panel (shows in middle or left position) */}
        {expandedFirm && renderCompanyPanel()}

        {/* Call Panel (Right) */}
        {showCallPanel && renderCallPanel()}
      </div>

      {/* Other Modals */}
      {renderModals()}

      {/* Sync Notification */}
      <div style={s.syncBar(!!syncNotif)}>
        <SyncIcon size={14} color={colors.green} />
        {syncNotif}
      </div>
    </div>
  );
}


const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(SalesPipelineApp));
</script>
</body>
</html>